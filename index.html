
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ashton Kemerling</title>
  <meta name="author" content="Ashton Kemerling">

  
  <meta name="description" content="Disclaimer: I am still not a doctor. Discuss with an actual doctor before beginning any diet or supplementation regime. I knew I was in trouble when &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.ashtonkemerling.com">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Ashton Kemerling" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32325955-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <h1>Ashton Kemerling</h1>
  
    <h2><a href="/">AK</a></h2>
  
</hgroup>

</header>
  <nav role="navigation">
  
<ul class="main-navigation">
  <li><a href="/about-me">About Me</a></li>
  <li><a href="https://www.countersteer.co">Podcast</a></li>
  <li><a href="https://www.hawkwood.group">Consulting</a></li>
  <li><a href="/resume">Resume</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/03/revive-by-totem-nutrition/">Revive by Totem Nutrition</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-06-03T17:45:00-07:00" pubdate data-updated="true">Jun 3<span>rd</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Disclaimer: I am still not a doctor. Discuss with an actual doctor before beginning any diet or supplementation regime.</p>

<p>I knew I was in trouble when clapping hurt. It was a cold morning in Chicago and I was driving myself to the gym, and the shivers caused me to clap my hands together rather than rub them, resulting in a searing hot line of pain to shoot up my right forearm. For the previous few weeks something had been not right, but now it was a capital P problem.</p>

<p>A few years prior, I had joined Forteza at the prodding of my wife. Back then I was working at a startup, and things had gotten pretty stressful at work. Like, &#8220;got hospitalized due to stress triggered psychosomatic problems&#8221; stressful. Leah knew about Forteza nearby, and figured that a bit of working out and fighting would be a good outlet for my stress.</p>

<p>It turns out she was right, go figure. Forteza is a historical fencing and martial arts gym nestled into the North side of Chicago. There I learned longsword fencing, yes longsword, wrestling, and medieval dagger fighting. The work was complicated, intense, dangerous, and deeply satisfying. More importantly than the specifics of my martial career, I discovered a love for fitness and sport.</p>

<p>I had never been a good athlete. Aside from peewee soccer, my entire sports story consisted of two disappointing years of wrestling, one of which terminated early due to my low ability. For most of highschool I actually spent more time in marching band than any other physical activity, although in my defense the band was significantly more successful than our football team. At Forteza my love for fencing eventually transformed into a pursuit of fitness in general, at first to improve my fighting stamina, and later for the sake of fitness itself. I started showing up at 6AM several times a week, rain or shine, to throw around kettlebells and get stronger along with a few other crazy diehards in the cold Chicago mornings.</p>

<p>But in my car that cold November, everything was in jeopardy. my wrist was hurting badly, and nothing was helping. I couldn&#8217;t hold a kettlebell with my right hand, nor could I perform the variety of snapping and rotating motions that longsword fencing requires. Something had to be done.</p>

<p>It turns out that there was something wrong with my ECU tendon, which runs from the base of my pinky along the outside of the wrist to the elbow. This tendon travels in a groove on the bone, and is held in place by a soft and flexible cover. Either due to genetics, which was my doctor&#8217;s explanation, or over training, I had managed to pop the tendon out of place, doing all kinds of damage to my wrist in the process. The solution was to either undergo some serious surgery to modify my bone structure and reset the tendon, a risky and expensive proposition, or sit still on it for months on end and hope that it gets better.</p>

<p>Unfortunately, this is just one of those injuries that will probably never go away. It kept me out of Forteza for the remainder of my time in Chicago, and even here in sunny LA it continues to be an occasional problem while training. Anything that involves compressing the wrist or rotating it under pressure is an injury risk for me, making some types of pushups and ring work tricky propositions that might end up in pain and reduced training.</p>

<p>The only thing I had ever found that helped my wrist was cryotherapy, which involves standing still in a -200F chamber for a few minutes. While this sounds miserable, and it is, it would almost instantly return range of pain free motion back to my wrist. It was also hard to get to, a temporary fix, and prohibitively expensive to do on a daily basis.</p>

<p>Thankfully, I&#8217;ve finally found a supplement that helps me out, and it&#8217;s called <a href="https://www.totemnutrition.com/shop-totem/revive">Revive</a> from <a href="https://www.totemnutrition.com">Totem Nutrition</a>.</p>

<p>Revive is basically a concentrated form of one of Lucid&#8217;s ingredients: Velvet Antler Extract, or VAE for short. It&#8217;s a tincture, which means its a few ingredients mixed with alcohol, that you take orally. Add a few drops, or a whole dropper, under your tongue and hold it as long as you can since the alcohol burns a bit. For me I&#8217;ve discovered that Revive is every bit as effective as Cryotherapy over the long term, even if the effect isn&#8217;t as instant as a -200F chamber can be.</p>

<p>Okay, so what&#8217;s Antler Velvet? Antler Velvet is the fuzzy layer that can be seen on top of deer, elk, or moose antlers; in this case we&#8217;re going to be working with Elk antler. In case you didn&#8217;t know, deer and similar animals grow a fresh set of antlers <em>every year</em>, which is insane when you think about it. While the antler is growing, up to an inch a day by the way, it&#8217;s covered in a fuzzy layer that contains all the support systems necessary to build an organ so quickly. Once the antler is done growing it sheds the velvet, leaving behind the hard and pointy antlers that we all know and &#8230;. love? Eventually these antlers fall off too, which is why you can occasionally find them laying around the woods in the right places.</p>

<p>Historically antler velvet was collected by hunters while hunting, which seems kind of obvious. If you&#8217;re a hunter and you can get some antler velvet along with your meat, this is obviously a good deal. But for those of us who want pound after pound of the stuff, that is a short term strategy. So Totem&#8217;s Elk Antler is harvested from semi-domesticated Elk. During the growing season they have their antlers trimmed, which is a bit like you or I cutting our toenails. All the work is done under the supervision of a veterinarian, just to make sure that the animals aren&#8217;t hurt. Obviously this means it isn&#8217;t a vegan product, sorry, but Totem promises that the Elk that lay the golden velvet are not being harmed.</p>

<p>So, what&#8217;s <em>in</em> the stuff? Lot&#8217;s of things, basically anything necessary to actually grow new parts of your body. For the Elk this is obviously the antlers, but for you it could be anything. One of the biggest ingredients is IGF-1, insulin like growth factor 1. IGF-1 is a protein that humans can synthesize ourselves, but we produce a lot less of it as we age. This is a problem, since IGF-1 is closely related to both mental and physical health, and is one of the reasons why exercising is so good for your brain. There&#8217;s also a lot of glycosaminoglycans, which aside from being really hard to pronounce are basically building blocks for skin and joints.</p>

<p>Beyond that there&#8217;s a huge list of Amino Acids that are helpful to you, including quite a few that are scientifically shown to improve your mood, including being precursors to making the happiness nerotransmitters - dopamine and seratonin. Obviously anything that helps you synthesize what&#8217;s known as the &#8220;happiness nerotransmitters&#8221; is something you&#8217;re going to want to have in your life.</p>

<p>Note: The ingredients in Revive are so potent that they&#8217;ve spent some time on and off the World Anti-Doping Agency&#8217;s banned substance list. I personally think this is insane, since it&#8217;s basically food and humans have been eating this stuff for millenia, but I&#8217;m also not a professional athlete who&#8217;s being tested on a regular basis. If you are a professional athlete who will be tested, be sure to do your own research.</p>

<p>Totem Nutrition offers a <a href="https://www.totemnutrition.com/money-back-guarantee">no stress money back guarantee</a> if you aren&#8217;t happy with their products for any reason. Best of all readers of my blog can get 10% off their first order by using the coupon code &#8220;ASHTON2018&#8221; on their first order.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/03/10/lucid-a-review/">Lucid: A Review</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-03-10T18:45:00-08:00" pubdate data-updated="true">Mar 10<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Disclaimer: I am not a doctor, and this is not medical advice.</p>

<p>Sleep. We all need it, and very few of us are getting enough of it. Hectic lives, work, children, poor diets, bright screens, and insufficient exercise often result in very poor sleep for those few hours that we are actually in bed. The result is a whole nation of people driving and working while sleep deprived, resulting in car crashes, low productivity, and general negative health outcomes.</p>

<p>Side note: Did you know that people who are sleep deprived are more likely to crave carbs and overeat? Just saying.</p>

<p>None of these things are changing soon; jobs aren&#8217;t becoming less hectic and screens certainly aren&#8217;t becoming more rare. We all know that we need to improve our diets and exercise more, but very few of us are actually doing it. So what&#8217;s to be done for the poor sleep deprived worker?</p>

<p>While most Americans would reach for drugs to fall asleep, I think supplementation is a far better answer. For the past two months I&#8217;ve been using <a href="https://www.totemnutrition.com/lucid-for-sleep-optimization">Lucid</a>, a supplement from Totem Nutrition, and it has radically altered my sleeping habits.</p>

<p>First off, what&#8217;s the difference between a drug and a supplement? Legal definitions non-withstanding, I use the following definition: a supplement is composed of naturally occurring or extracted compounds, while a drug is a new creation that&#8217;s completely new to the human body. I&#8217;m not one of those people who think that all-natural is the same as safe, since nature manages to produce some pretty poisonous stuff on its own. What I do believe is that well vetted supplements tend to be far more gentle and free from side effects than legal prescription drugs. That&#8217;s been my experience at least.</p>

<p>Okay, back to Lucid. So what in the heck is it? Well it&#8217;s a sleep aid, a supplement that&#8217;s designed to help you fall asleep faster and sleep better. It comes in a liquid form in a dropper bottle, and you&#8217;re supposed to hold it under your tongue for about a minute before you go to bed. I <em>really</em> like supplements that come in liquid form, because they&#8217;re far easier to adjust the dosing on. For me, half a droppers worth of Lucid does the trick.</p>

<p>You might be tempted to compare it to drugs like Ambien, but how they work is basically completely different. Ambien is a sedative, it literally knocks you out. This might beat laying awake staring at your ceiling, but it has not been shown to improve sleep <em>quality</em>. Also, it increases your risk of doing something silly like hopping into your car naked and crashing it into your neighbor&#8217;s house.</p>

<p>Rather than forcing your body to sleep, Lucid is designed to help your body through the entire sleep process. It contains the basic ingredients your body can consume in order to sleep deeply and recover from your day.</p>

<p>First of all, this supplement actually contains a few different supplements I&#8217;ve used on and off over the years. Melatonin (you&#8217;ve heard of this right?), Velvet Antler Extract, and Colostrum. I&#8217;ll go over what these are and why I&#8217;ve used them before in a bit. Your body knows how to use these to make you sleep, among other things, but it won&#8217;t overuse them. Example: Lucid contains the pre-cursor compounds for testosterone. If you&#8217;re running short on this vital hormone, and yes ladies need it too, then your body can use these compounds to make more. But if you&#8217;re not running low on testosterone your body <em>won&#8217;t</em> overdo it, so no it won&#8217;t turn you into Dolph Lundgren or anything, sorry.</p>

<p>Subjectively, I&#8217;ve noticed that Lucid has helped me sleep better and wake up better. I spend a lot less time in the morning trying to wake up enough to get dressed and make coffee since I&#8217;ve started taking Lucid. I&#8217;ve also noticed a marked reduction in tossing and turning, as well as the minor aches and pains that I pick up from the gym. I typically haven&#8217;t struggled to fall asleep, so I can&#8217;t comment on how Lucid helps me there.</p>

<p>Objectively, I&#8217;ve been tracking my sleep via the lovely AutoSleep app for my Apple Watch. I&#8217;ve noticed two different things since taking it.</p>

<p>First of all, taking Lucid has comfortably added 30 minutes to an hour of &#8220;Deep Sleep&#8221; to my nightly statistics, take a look at a <a href="/images/control.jpeg">control</a> night and a night <a href="/images/lucid.jpeg">with lucid</a>. I&#8217;ve also noticed fewer incidents of waking up in the middle of the night, and my sleep data shows that I&#8217;m more consistently asleep. Well, except for when the cats start crying and biting me for breakfast early. Nothing short of a serious sedative could keep me asleep through that.</p>

<p>More shockingly is what it does combined with alcohol. Alcohol is not good for your sleep, even if it does knock you out quickly. On nights where I drank and forgot my Lucid (hey, nobody is perfect) I averaged a miserable <a href="/images/alcohol.jpeg">15-30 minutes of deep sleep</a>. On nights where I drank and remembered my Lucid I got anywhere from an <a href="/images/lucidandalcohol.jpeg">hour and a half</a> to two hours of deep sleep, which is pretty close to a regular night of sleep. Look, I&#8217;m not saying that Lucid is a hangover cure, but I am definitely saying that it helped.</p>

<p>Cool, so what&#8217;s in it?</p>

<ul>
<li>Melatonin - To help you get sleep.</li>
<li>Velvet Bean - Prevents a sleep hangover.</li>
<li>Vitamin B6 - Energy &amp; Mood enhancer.</li>
<li>Colostrum - Growth factors &amp; immune booster</li>
<li>Velvet Antler Extract (VAE) - Pure magic.</li>
<li>Water - Duh</li>
<li>Alcohol - To protect some of the more fragile ingredients.</li>
</ul>


<p>Velvet Antler is the one I&#8217;m most interested in. I have very fragile tendons in my wrists because of a genetic mutation I have, and statistically 1/3rd of you reading this share that mutation with me. These tendons always get sore from working out, and can strain extremely easily. I&#8217;ve had to miss close to a year&#8217;s worth of gym time because of injuries to this part of my body. The only thing that got me back to training was cryotherapy, I&#8217;ll talk about that another time, and Velvet Antler Extract.</p>

<p>So why don&#8217;t I just take it alone? Well, I could, but taking VAE as part of my sleep routine is awesome. First of all, it&#8217;s one less supplement to take daily, and that&#8217;s great. Secondly I have to take Lucid at night, no point in making myself drowsy at lunch, which means that I get a dose of VAE right before my body does its best repair work: at night. And did I mention that I like getting a good&#8217;s night sleep? What&#8217;s not to love?</p>

<p>Anyways, I highly recommend that you give Lucid a try. A bottle lasts me about a month or so, and for me it&#8217;s a good deal to ensure a great night&#8217;s sleep.</p>

<p>Totem Nutrition, the makers of Lucid have been generous enough to offer my readers a 10% discount for trying out Lucid. Use the code &#8220;ASHTON2018&#8221; for 10% off your first order through the end of 2018.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/02/21/no-you-probably-dont-need-a-blockchain/">No, You Probably Don&#8217;t Need a Blockchain</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-02-21T18:39:00-08:00" pubdate data-updated="true">Feb 21<span>st</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>On Bitcoins and Blockchains</h1>

<p>Oh Bitcoin, the darling of everyone&#8217;s economic dreams. Some think it&#8217;ll destroy the fed, others hope it&#8217;ll kill off the big banks. Some just think it&#8217;s going to make them rich, others go as far as hoping it&#8217;ll kill off governments completely. Whatever you happen to hate, Bitcoin is coming to destroy it!</p>

<p>All of this is complete nonsense, of course. There are enough mutually exclusive dreams about Bitcoin that it&#8217;s clear that not all of them can come true, possibly even the hopes of easy riches given its unpredictable volatility.</p>

<p>But even if you don&#8217;t buy into the dream of buying bitcoins to turn them into Lambos or whatever, chances are you are hearing from every single corner that Bitcoin isn&#8217;t the future, it&#8217;s the blockchain! This refrain has been said so many times that even Bitcoin skeptics feel the need to mention that the blockchain will change the world, even if they don&#8217;t think that Bitcoin itself will. That this refrain becomes louder whenever Bitcoin is dropping vs. USD doesn&#8217;t seem to worry that many people.</p>

<p>I personally think all of this blockchain stuff is bunk. I am extremely skeptical that the blockchain is indeed the future, and if there will be any future uses for it I don&#8217;t think we&#8217;ve seen it yet. What we have seen instead is a ton of hype and not a small amount of straight up fraud, which I find worrying.</p>

<h2>A Pesky Disclaimer.</h2>

<p>First of all, I am not a financial adviser. If you take any of this as advice as far as what to buy or sell, both of us will be very sad. Well, you probably will be sad, I will be annoyed if you bug me about it. If you want legit financial advise, go find an actual financial adviser and <em>pay them</em>.</p>

<p>Secondly, predicting the future is <em>hard</em>. While I am confident that I have not seen any uses for the technologies discussed yet, I am not foolish enough to think that there is a 0% chance that one ever will. I will lay out why I think it&#8217;s unlikely, but only time will tell.</p>

<h1>So, What <em>is</em> a Blockchain Anyways?</h1>

<p>A blockchain is a way of recording a series of transactions in a publicly visible and immutable way. Individual transactions are created with private encryption keys, and then bundled into blocks. Each block is then publicly verified against some sort of algorithm, typically one that involves a lot of computational power to get done. Each verified block contains a reference to the previous block, thus creating a chain of blocks, or a blockchain. The idea is that blocks are very expensive to create, but very cheap to check. If you wish to check the balance or history of a given bitcoin address (&#8220;wallet&#8221;), then you merely need to scroll backwards through all the blocks and check for any transaction that references that address.</p>

<p>The basic idea is that the verification of any transaction is essentially trustless, there doesn&#8217;t need to be any central authority to provide the record of any transaction. All you need is a copy of the blockchain in order to verify any past transaction, should you wish to do so. If you wish to do any transaction on the blockchain, all you need is a copy of the private key for a given wallet. These can be stored in a variety of ways in software or hardware. The people verifying blocks will facilitate your transaction without you or them knowing who each other is.</p>

<h2>So, Why the Talk of Blockchains Instead of Bitcoin?</h2>

<p>Because Bitcoin uses <em>a</em> blockchain, but it isn&#8217;t <em>the</em> blockchain. A blockchain effectively consists of the rules of the chain, the current chain, and all the participants in it. The chain itself is the combination of the starting block, and the longest accepted chain of transactions. This is why there are so-called altcoins, which are blockchain currencies that use slightly different rules or a different initial starting block from the blockchain.</p>

<p>More interestingly still are cases where sections of a blockchain decide that a specific block was invalid, either for security or political reasons. These create a so-called hard fork, where two competing blockchains exist that share a large section of their history. A good example of this is the ever controversial <a href="https://en.wikipedia.org/wiki/Bitcoin_Cash">Bitcoin Cash</a>, which was created to overcome perceived deficiencies in Bitcoin itself. If you owned Bitcoin before the fork in August of 2017, then you now own an equal amount of Bitcoin and Bitcoin Cash. Whether or not you think this is economically sound is up to you.</p>

<h1>So, Why Don&#8217;t You Like Blockchains?</h1>

<p>I think blockchains are a novel combination of existing technologies, what I am not convinced of is their long term utility. While it&#8217;s been fun to watch a speculative bubble from around cryptocurrencies and their related companies, to my eyes most attempts to expand the blockchain beyond that bubble strike me as foolish at best.</p>

<h2>Immutability Woes</h2>

<p>Blockchains are by their very design immutable. Barring extreme measures, any transaction entered into them is permanent and irreversible. For financial systems this has a lot of obvious drawbacks: fraudulent or mistaken transactions cannot be undone. Ebay purchaser did not deliver? Tough. Someone held you <a href="https://www.ccn.com/man-held-gunpoint-bitcoin-comes-forward/">hostage</a> until you sent them bitcoin? Tough. Private key hacked, or hard drive destroyed? That&#8217;s unfortunate for you. The only way to recover bad bitcoin transactions is to convince everyone to do a hard fork, and needless to say that the bar for that is very very high.</p>

<p>But that&#8217;s just finance, what about industry? It turns out, that there&#8217;s very few systems that truly benefit from an inability to amend or update transactions. Humans bungle input into computers all the time, there&#8217;s a whole sector of the economy (customer service) designed to help deal with that. But in an immutable system, it is literally impossible to undo anything written to the blocks. The only possible way to somewhat reverse a bad transaction is to literally make the inverse transaction the next time around, which would involve convincing the opposite party to cooperate. This would rapidly clutter up the chain full of &#8220;oops&#8221; transactions, which would pretty quickly make you wonder why you&#8217;re bothering at all.</p>

<h2>That Pesky Real World Thing</h2>

<p>One of the most common proposed usages of blockchain is to track the shipment of real world goods, including everything from food to diamonds. On the surface this sounds great, you could easily and trustlessly prove that the shiny rock in your beloved&#8217;s ring wasn&#8217;t mined by children in a war torn region, fantastic!</p>

<p>The problem is that computers are not the real world. Currently blockchains have a very hard time affecting even digital systems that are not on the blockchain, which is why centralized exchanges exist to facilitate buying bitcoin with USD/EUR/etc. Actually trying to make computers in general reflect the real world is a very hard task, and the blockchain does nothing to solve this issue.</p>

<p>Imagine that you are a blood diamond distributor. You know that rich westerners love diamonds, but feel a bit bad about children being hurt and killed to mine these conflict diamonds. You have a huge incentive to simply lie to the computer to create a fraudulent paper trail for these diamonds, thus generating a higher market value for them. There&#8217;s nothing about the blockchain that prevents humans from lying or mistakenly entering the wrong values, and the immutable nature of blockchains makes the cost of mistakes oh so much higher.</p>

<p>Don&#8217;t bother thinking about secure hardware at verified locations. At its heart blockchains only require a password to operate, as once you have the private key you can create transactions trivially. If media pirates can extract decryption keys from BluRay players, I guarantee you that diamond smugglers will be able to figure this out too. Once the hardware is in the attackers hands, it is only a matter of time until they strip it down to extract the keys.</p>

<p>The only way around this is to have a trusted neutral party verifying that goods come from exactly where they claim to be from. Not only does this fly in the face of the &#8220;trustless&#8221; idea above, but handing said employee the ability to create immutable &#8220;this diamond is legit&#8221; records puts that employee in way more danger than need be. There&#8217;s literally nothing about this system that&#8217;s superior to what we already have.</p>

<h2>Power &amp; Motivation</h2>

<p>Blockchains typically use the &#8220;Proof of Work&#8221; system, where multiple participants try to solve a difficult problem in order to certify a block to be valid. The problem is hard to prevent one person from controlling too much of the mining (computational) pool. This is one of the reasons why Bitcoin itself currently consumes roughly as much power as Delaware while processing about 4 transactions a second.</p>

<p>Problem: that much electricity is very expensive, as is all of the specialized hardware required to do it. Those that do the work, miners, are commercial operations and expect to be rewarded for their effort. With Bitcoin and other currencies, this reward is the currency itself. The first miner that solves the problem is rewarded with a few Bitcoins, hence the unkind comparisons to Ponzi or MLM schemes. In any non-monetary application, these miners will need to be compensated to do the work running the blockchain. Given the inefficiency of Proof of Work, this will be orders of magnitude more expensive than a similarly sized centralized solution.</p>

<p>There are two solutions to this. Offer miners a token of some sort for their work, or run all the hardware yourself. The former is the basis of many ICOs, and most have more than a whiff of fraud about them. The latter is basically just a really crappy traditional system with some fancy terminology and a very expensive power bill.</p>

<h3>Proof of Stake</h3>

<p>There&#8217;s an alternative system to Proof of Work, which is Proof of Stake. In Proof of Stake the person holding the most old currency is selected as the person who will validate the latest block. Rather than each validator getting paid a set amount of new coins, they are paid a fee by everyone hoping to transact in order to validate the block. Rather than keeping the longest chain as the most valid, since the longest chain in Proof of Work is the most mined, the chain with the most old money in it is determined to be valid in Proof of Stake.</p>

<p>Proof of Stake solves some, but not all, of the most egregious problems with the current Proof of Work system. The power and silicon bill would be significantly lower, but not necessarily free. You&#8217;d still need to pay people to use their phone/computer/whatever to run transactions on it. The chain would also run more transactions, better than the miserable 4/s on bitcoin, but this would only increase the size of the overall chain. Remember, every transaction <em>ever</em> stays on the blockchain permanently. The Bitcoin blockchain is currently 157GB in size, and that&#8217;s at a very low transaction speed. The idea of everyone mining on their phone is just laughable.</p>

<p>Also, Proof of Stake doesn&#8217;t improve the real world interface or immutability problems above.</p>

<h2>Scale</h2>

<p>To be blunt, the performance of basically all blockchain systems today is garbage. The limited number of transactions that can fit into a block, and the amount of work it takes to prove a block means that blockchain systems using Proof of Work limits their maximum throughput to very low numbers. Bitcoin for example can handle on average 3-4 transactions a second, tops. Ethereum does better in the 15-20 a second range. Both pale in comparison to the average 1,667 transactions a second Visa handles per second based on their reported daily volume, with their peak volume probably being higher. To simplify, Visa can handle the transactions of an good sized nation state, bitcoin can handle the transactions of a few Costcos.</p>

<p>I question how many industrial systems are worth spending the electricity on and need a transaction volume in the single digits a second range. Probably not many.</p>

<p>Note: There are some plans to improve Bitcoin&#8217;s transaction speed, mostly by ditching the blockchain itself for all but the rarest of cases. Given that these solutions will appear <em>any day now</em> makes me doubt that they&#8217;re actually viable. These also include a lot of serious safety drawbacks that are not worth getting into here.</p>

<h2>ICOs, Also Fraud</h2>

<p>An interesting sub-genre of the cryptocurrency space are Initial Coin Offerings. This is where someone creates a new cryptographic coin representing a stake in some new venture. These coins are sold off to the highest bidder in order to raise funds, and then eventually the coins will be useful and valuable because magic. Needless to say, there is a <em>ton</em> of fraud in the ICO space.</p>

<p>First of all, ICOs are designed to look a lot like Initial Public Offerings (IPOs), except without all those pesky regulations. The fact that many ICOs confer no voting or dividend rights upon the purchaser, and sometimes aren&#8217;t allowed to be sold according to the contract has yet to dissuade the market. Even the most up and up ICO typically doesn&#8217;t provide any particular reason why these tokens should be worth anything in future.</p>

<p>Second, did I mention fraud? It&#8217;s estimated that up to 10% of the funds put into ICOs has been straight up stolen. Sometimes this is the creator of the ICO collecting bitcoin or whatever for the ICO and never delivering the token, simply replacing their website with <a href="http://nymag.com/selectall/2018/01/prodeum-scam-cryptocurrency-for-produce-disappears.html">a the word &#8220;penis&#8221;</a> and laundering the currency. Other times its trivial integer underflow bugs letting someone steal <a href="https://blog.goodaudience.com/how-800k-evaporated-from-the-powh-coin-ponzi-scheme-overnight-1b025c33b530">$800k</a> from a 4chan backed ICO. Half the time the funds are &#8220;stolen&#8221;, it is unclear whether or not a third party took it, or whether or not it&#8217;s an exit scam disguised as a hack.</p>

<p>Third, very few of these ICOs have even the slightest hint at being related to crypto or valuable in any meaningful way. I&#8217;ve covered the issue with supply chain blockchains above, but &#8220;dating on the blockchain&#8221; and &#8220;porn on the blockchain&#8221; is all meaningless bullshit, especially now that nobody really cares what you view in the privacy of your own home anymore. And that&#8217;s not even considering the insanity that is backing an ICO with <a href="https://bananacoin.io/">bananas</a>. No, I am not kidding. They claim that they they&#8217;ve raised $3,038,361.90, by the way.</p>

<p>For a good example of the nonsense of ICOs, look into the <a href="https://www.kerrisdalecap.com/wp-content/uploads/2018/02/Eastman-Kodak-Company-KODK.pdf">pre-mortem</a> of Kodak&#8217;s ICO. The whole plan is bullshit from top to bottom, and includes a non-trivial amount of insider trading. If the Kodak board isn&#8217;t arrested within the next year for insider trading I will be genuinely shocked.</p>

<h1>But What About Smart Contracts?</h1>

<p>Ethereum is the one interesting outlier of all of the crypto currencies and blockchain technologies. Ethereum provides the user with a simple, if not problematic, programming language. You can generate programs, or &#8220;smart contracts&#8221; (let it not be said that crypto fans are bad at marketing), and run them on the Ethereum blockchain. You have to pay a small fee in ETH, called &#8220;gas&#8221; based on the complexity of your program, and the result of the program must be some sort of Ethereum transaction. Thus the value of ETH is nominally backed by the utility of running programs on the Ethereum blockchain itself.</p>

<p>On the face of it, smart contracts are an interesting idea. You could cut a lot of legal and human complexity/overhead out by making contracts that self execute. Most smart contract fans repeat the phrase &#8220;code is law&#8221; in reference to the above idea. Of course, writing programs that produce permanent financial consequences gives me some pretty serious anxiety, and I would hope that most senior engineers would feel the same. And given the number of high profile and high value hacks on Ethereum contracts over the years, it seems like my fears are well founded. That one of the <a href="https://www.coindesk.com/understanding-dao-hack-journalists/">hacks</a> was serious enough to trigger a hard fork in Ethereum implies that I&#8217;m onto something. It turns out that &#8220;code is law&#8221; is a popular idea right up until enough people lose their money.</p>

<p>On top of that, as best I can tell a <em>large</em> percentage of Ethereum contracts are literal Ponzi schemes and ICO tokens, the later being easy to bootstrap on top of Ethereum using a protocol called ERC20. This calls into question the long term viability of &#8220;smart contracts&#8221;, given that the main usage for this system so far appears to be fraud and refreshingly honest fraud.</p>

<h1>Conclusion</h1>

<p>No, you probably don&#8217;t need a blockchain.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/01/mdc-and-threadpools/">MDC and Thread Pools: A Bad Combination</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-09-01T15:01:00-07:00" pubdate data-updated="true">Sep 1<span>st</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Well written web services must have clear and easy to follow logs. Without good logs a programmer will be unable to diagnose or reproduce problems that might arise. And while many systems will keep logs in their reverse proxy like Nginx, a well written system will also have application/domain specific logs written within the application itself.</p>

<p>A common goal of application logs is to tie a given log line to a specific request. Because modern servers are multi-threaded, it is possible for multiple requests to be serviced at the same time, resulting in log messages from different requests being intermingled in the log output.</p>

<p>According to all the documentation I have found, the standard way to resolve this is to use the Mapped Diagnostic Context, or <a href="https://logback.qos.ch/manual/mdc.html">MDC</a>. The MDC wraps a thread local hashmap, whose values can be used in your log patterns. On paper you could generate a UUID per request, insert it into the MDC and presto you have a UUID per request in each log line! Since threads are created per request, the MDC will be empty each time.</p>

<p>Except, that&#8217;s not really how Java programming works these days. Threads are expensive, and so for the sake of efficiency modern Java aims to minimize the number of threads created. This means using non-blocking IO (NIO), or reusing threads via Thread Pools where possible, which avoids creating new threads. As such there are quite a few number of APIs in Java 8 and some modern web servers that make it trivial to make your code non-blocking and use a common thread pool.</p>

<p>So, what happens to our MDC when we reuse threads? Well, we end up with the wrong MDC! Here&#8217;s some code for Java 8 that shows the problem:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.slf4j.MDC</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.CompletableFuture</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CORRELATION_ID</span> <span class="o">=</span> <span class="s">&quot;correlation-id&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">logger</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">stepOne</span><span class="o">(</span><span class="n">String</span> <span class="n">correlationId</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CORRELATION_ID</span><span class="o">,</span> <span class="n">correlationId</span><span class="o">);</span>
</span><span class='line'>            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Step One&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="s">&quot;Foo&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">stepTwo</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">previous</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">previous</span><span class="o">.</span><span class="na">thenApplyAsync</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Step Two&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="s">&quot;Bar&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">stepThree</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">previous</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">previous</span><span class="o">.</span><span class="na">thenApplyAsync</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Step Three&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="s">&quot;Baz&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">doAll</span><span class="o">(</span><span class="n">String</span> <span class="n">correlationId</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">stepThree</span><span class="o">(</span><span class="n">stepTwo</span><span class="o">(</span><span class="n">stepOne</span><span class="o">(</span><span class="n">correlationId</span><span class="o">))).</span><span class="na">join</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">Main</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>        <span class="n">doAll</span><span class="o">(</span><span class="s">&quot;correlation-id-one&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">doAll</span><span class="o">(</span><span class="s">&quot;correlation-id-two&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code is using the new <code>CompletableFuture</code> class from Java 8, which is <em>roughly</em> analogous to Javascript promises. What we do is set the correlation-id, then execute a sequence of asynchronous actions and log the output. If you run this code enough times, you will eventually get the output below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">12</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span><span class="mf">55.465</span> <span class="o">[</span><span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">commonPool</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="n">INFO</span>  <span class="n">correlation</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="n">correlation</span><span class="o">-</span><span class="n">id</span><span class="o">-</span><span class="n">one</span> <span class="o">-</span> <span class="n">Step</span> <span class="n">One</span>
</span><span class='line'><span class="mi">12</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span><span class="mf">55.466</span> <span class="o">[</span><span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">commonPool</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="n">INFO</span>  <span class="n">correlation</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="n">correlation</span><span class="o">-</span><span class="n">id</span><span class="o">-</span><span class="n">one</span> <span class="o">-</span> <span class="n">Step</span> <span class="n">Two</span>
</span><span class='line'><span class="mi">12</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span><span class="mf">55.466</span> <span class="o">[</span><span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">commonPool</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="n">INFO</span>  <span class="n">correlation</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="n">correlation</span><span class="o">-</span><span class="n">id</span><span class="o">-</span><span class="n">one</span> <span class="o">-</span> <span class="n">Step</span> <span class="n">Three</span>
</span><span class='line'><span class="mi">12</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span><span class="mf">55.467</span> <span class="o">[</span><span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">commonPool</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="n">INFO</span>  <span class="n">correlation</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="n">correlation</span><span class="o">-</span><span class="n">id</span><span class="o">-</span><span class="n">two</span> <span class="o">-</span> <span class="n">Step</span> <span class="n">One</span>
</span><span class='line'><span class="mi">12</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span><span class="mf">55.467</span> <span class="o">[</span><span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">commonPool</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="n">INFO</span>  <span class="n">correlation</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="n">correlation</span><span class="o">-</span><span class="n">id</span><span class="o">-</span><span class="n">two</span> <span class="o">-</span> <span class="n">Step</span> <span class="n">Two</span>
</span><span class='line'><span class="mi">12</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span><span class="mf">55.467</span> <span class="o">[</span><span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">commonPool</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="mi">2</span><span class="o">]</span> <span class="n">INFO</span>  <span class="n">correlation</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="n">correlation</span><span class="o">-</span><span class="n">id</span><span class="o">-</span><span class="n">one</span> <span class="o">-</span> <span class="n">Step</span> <span class="n">Three</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pay attention to the last line, which should have a correlation-id of correlation-id-two. Instead we have an earlier correlation-id because we happened to reuse a thread from earlier. This is an unmitigated disaster, as now you don&#8217;t have missing logs, you have misleading logs. In a less-simple scenario it would be absolutely impossible to tell whether or not that correlation-id was correct, and you might end up diagnosing bugs that don&#8217;t exist within your system because of this.</p>

<p>Java 8 and <code>CompletableFuture</code> make this much more plausible by making it very easy to use the <code>ForkJoinPool</code>. <code>CompletableFuture</code> provides a number of methods to create a new <code>CompletableFuture</code>, or to take one <code>CompletableFuture</code> and transform it into another. Most of these methods have at least two signatures: <code>x</code> and <code>xAsync</code>. The former will do all the work on the current thread, the latter will automatically use the <code>ForkJoinPool</code> to execute asynchronously. Optionally you can provide your own <code>Executor</code>, which might be backed by your own managed thread pool.</p>

<p>From a performance standpoint, this is amazing. I can separate the business logic from the execution strategies completely. With very minor code changes, sometimes only a method name, I can turn synchronous code to asynchronous or back again. But from a logging stand point this is very fragile. Correctly using the MDC depends on staying on the current thread, and Java 8 makes it very easy to hop threads by design. Worse, the above incorrectness is subtle, so your logs could be left incorrect for years without any immediate impact.</p>

<h2>Recommendations</h2>

<p>Don&#8217;t use the MDC, it&#8217;s too unsafe. Every time you change threads, you will either get an empty MDC (best case scenario), or MDC values from an older request (worst case scenario). At every single point where you might hop threads, it will be necessary to copy the current MDC settings to a local variable, close over it in your next lambda, and set the new thread&#8217;s MDC to the correct value before logging on the new thread. If any new asynchronous step is introduced without doing the above work, the correct values are lost for the rest of the request resulting in malformed or incorrect logs. Considering that adding &#8220;Async&#8221; to the end of a method name is enough to hop threads, this is a lot of work.</p>

<p>The easiest solution is to forgo logging request specific identifiers. Remove any reference to the MDC from your code and log configuration, and move on. If your request volume is relatively low, this might be a perfectly reasonable solution for you.</p>

<p>If you must track every single action down to a single request, you will need to pass around an object for each request which will contain any request specific information you want to log. You can setup logging interfaces that require the <code>Request</code> object to ensure log uniformity, which means that failing to pass this object will be a compilation error. As a side benefit, these custom logging interfaces would be extremely useful in enforcing consistent log messages, and a good place to inject statistics gathering.</p>

<h2>Addendum</h2>

<p>The MDC docs are incorrect, with sections of the documentation explicitly referencing out of date information. I draw your attention to the section titled &#8220;MDC and Managed Threads&#8221; which says the following:</p>

<blockquote><p>A copy of the mapped diagnostic context can not always be inherited by worker threads from the initiating thread. This is the case when java.util.concurrent.Executors is used for thread management. For instance, newCachedThreadPool method creates a ThreadPoolExecutor and like other thread pooling code, it has intricate thread creation logic.</p></blockquote>

<p>As it turns out, a copy of the mapped diagnostic context will <strong>never</strong> be inherited by a worker thread. <a href="https://github.com/qos-ch/logback/commit/aa7d584ecdb1638bfc4c7223f4a5ff92d5ee6273">This</a> change guarantees that each thread gets a new, empty MDC. This documentation is correct for older version of logback, but it is not correct anymore. I&#8217;m sure the quote above was accidentally left in place, as the correct behavior is mentioned at the top of the document. It&#8217;s just a good reminder to read documentation carefully, and understand that humans can make mistakes in the docs too.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/01/26/java-without-if/">Java Without If</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-01-26T19:54:00-08:00" pubdate data-updated="true">Jan 26<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Over the past year my team has been doing something shocking to a lot of
engineers: we&#8217;re favoring pure Java over Clojure. We aren&#8217;t rewriting all our
Clojure code, but we definitely prefer Java for green field projects.</p>

<p>This post is not going to be a compare and contrast between the two, nor am I
going to bash Clojure. Language compare and contrast posts always descend into
flame wars, and it&#8217;s very easy to confuse the result of hard lessons learned
with the benefits of a new language.</p>

<p>Instead I&#8217;d like to highlight a very strange aspect of our new Java development,
and I hope that you&#8217;re sitting down for this. Except tests, I have fewer than a
dozen <code>if</code> statements currently committed in our Java codebase.</p>

<p>It would be easy to assume that we&#8217;re just using Java&#8217;s method dispatch to
replace if statements; rather than inspecting data and calling if/else on it,
you can use interfaces and count on the implementation to provide the difference
in behavior. But such an explanation is insufficient: objects don&#8217;t magically
construct themselves from unstructured data, and Clojure is not without its own
dynamic dispatch <a href="https://clojure.org/reference/multimethods">facilities</a>.</p>

<p>Ultimately the real explanation for this strange code design lies in my
colleague&#8217;s extremely exceptional <a href="https://github.com/palatable/lambda">Lambda</a>
library. It contains a lot of things that a Haskell/Scala developer would
recognize such as Either types, function utilities, coproducts, etc. etc.</p>

<p>In particular I&#8217;d like to draw your eye to the Either type, which has replaced
the vast majority of our explicit <code>if</code> calls. Either is the logical
successor to the Java
8 <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html">Optional</a>
type. Optional represents the presence of a value of type <code>T</code> with
 <code>Optional::of</code>, or it&#8217;s absence with <code>Optional::empty</code>. Either on the
other hand is parameterized to two values, L and R, and represents the presence
of either a value of type L, <em>or</em> a value of type R.</p>

<p>Why is this a logical extension of <code>Optional</code>? Because while Optional is
used to represent a result that may have no value (replacing a null), Either is
used to represent a result that might have been a failure, replacing a thrown
exception, with convention being that left side values represent failure and
right side values representing success.</p>

<p>So, what does that buy us? Well, consider what Optional gets us in the following code snippets.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Helper</span><span class="o">.</span><span class="na">functionOne</span><span class="o">();</span>
</span><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">x</span> <span class="o">=</span> <span class="n">Helper</span><span class="o">.</span><span class="na">functionTwo</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
</span><span class='line'>  <span class="n">x</span> <span class="o">=</span> <span class="n">Helper</span><span class="o">.</span><span class="na">functionThree</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Helper</span><span class="o">.</span><span class="na">functionOne</span><span class="o">()</span>
</span><span class='line'>                           <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Helper:</span><span class="o">:</span><span class="n">functionTwo</span><span class="o">)</span>
</span><span class='line'>                           <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="nl">Helper:</span><span class="o">:</span><span class="n">functionThree</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Optional gives us the ability to say &#8220;if a value exists, apply this function to
it&#8221; repeatedly. It also gives us the ability to chain successive calls that
return Optionals together with the <code>flatMap</code> function, eliminating the need
for unsightly and error prone manual null checks. It&#8217;s also safe for <code>map</code>
and <code>flatMap</code> to go from <code>Optional&lt;A&gt;</code> to <code>Optional&lt;B&gt;</code>, which might
eliminate the need for intermediate variables in your code.</p>

<p>Either give us much of the same, but with the ability to represent <strong>why</strong> the
computation failed with left values, along with the ability to chain together
functions working on an Either type. All of the greatest hits of functional
programming are provided for Either, including <code>map</code>, <code>flatMap</code>, and <code>filter</code>.</p>

<p>As a concrete example, imagine a hypothetical JSON parsing library. Parsing is
tricky business, you&#8217;re all but guaranteed that a failure will happen at
runtime. So how do you handle it? Previously you had 4 choices.</p>

<ul>
<li>return null</li>
<li>return Optional&lt;ParsedType></li>
<li>checked exception</li>
<li>unchecked exception</li>
</ul>


<p>Null is obviously bad, and unchecked exceptions are also risky. Checked
exceptions guarantee that someone will deal with the issue, but they are
extremely annoying, and might result in disparate and different exception
handlers all over the place. Optional is nice, it&#8217;s safer than null and marks in
the type signature that failure is an option, but it&#8217;s a bit lacking on
explaining <strong>why</strong> a failure occurred.</p>

<p>What if instead this library returned <code>Either&lt;Exception, JsonNode&gt;</code>, or even
 <code>Either&lt;Set&lt;String&gt;, JsonNode&gt;</code>? The potential for failure is in the type
signature again, we don&#8217;t need a try/catch, but if we want the unwrapped
JsonNode we have to deal with the potential for a left value. And any functions
we have that operate only on JsonNode can be passed in using the <code>map</code>
function, making chaining a breeze.</p>

<p>Better still we can write other functions that might fail in this form, such as
JSON validation, so that we can chain them together using <code>flatMap</code>. If the
json parsing has failed, flatMap does nothing (it only works on right values),
replacing the need for successive null checks, nested try/catch blocks, or
complicated state checking during exception handling to return the correct
value.</p>

<p>As a result of all this, you can easily imagine a JSON API endpoint looking
something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="n">HttpResponse</span> <span class="nf">handle</span><span class="o">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">JsonParser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getBody</span><span class="o">())</span>
</span><span class='line'>                     <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="nl">Validator:</span><span class="o">:</span><span class="n">validate</span><span class="o">)</span>
</span><span class='line'>                     <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">ServiceObject:</span><span class="o">:</span><span class="n">businessLogic</span><span class="o">)</span>
</span><span class='line'>                     <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="nl">JsonGenerator:</span><span class="o">:</span><span class="n">generate</span><span class="o">)</span>
</span><span class='line'>                     <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">l</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="o">.</span><span class="na">internalServerError</span><span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()),</span>
</span><span class='line'>                            <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="n">l</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>All the potential failure cases are covered by returning an Either rather than
throwing an exception. The very last step is <code>match</code>, which takes two
functions to unify a potential left or right value to the exact same type, which
in this case is <code>HttpResponse</code>.</p>

<h3>What does this get me?</h3>

<p>Well, first off I think it&#8217;s beautiful. I know that&#8217;s a subjective call, but the
data flowing neatly from top to bottom without huge nesting if cases and early
return values is very aesthetically pleasing to me.</p>

<p>More functionally it&#8217;s easier to refactor with the help of the compiler. If I
want to add different return status codes to match different scenarios, the
compiler helps me out a lot more than if I&#8217;m adding an extra return case. If I
convert the left side to a HttpResponse early, the compiler will helpfully
remind me that the later flatMap calls cannot change <code>Either&lt;HttpResponse,
JsonNode&gt;</code> to <code>Either&lt;Exception, BusinessObject&gt;</code>. Such changes are easily
fixed once the compiler has pointed it out, but extremely hard to find on your
own.</p>

<p>But most fundamentally is that we&#8217;ve encoded our code&#8217;s states in the type
system, not variable states. The potential for JSON parsing to fail is encoded
in its type, not in the potential for a variable to null, or false, or for an
exception to have been thrown. You&#8217;re leaning on the compiler to tell you if
you&#8217;ve handled the failure cases properly, as the code won&#8217;t compile otherwise.
Now instead of testing for runtime exceptions you only test to make sure that
your business logic is correct.</p>

<p>If you&#8217;ve ever been interested in what the Haskell or Scala developers have been
talking about with functional type safety, I&#8217;d highly recommend taking a look at
Lambda to get a taste of it in Java.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/11/my-increasing-frustration-with-clojure/">My Increasing Frustration With Clojure</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-06-11T06:24:00-07:00" pubdate data-updated="true">Jun 11<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Edit: TL;DR: This is about how bugs in Clojure are handled by the Clojure Team, not just complaints about specific bugs I&#8217;ve seen.</strong></p>

<p>First off, this is not a &#8220;I&#8217;m quiting in disgust&#8221; post. Those are childish and a waste of everyone&#8217;s time. But this is a post of frustration as I watch something I really like being slowly allowed to get worse.</p>

<p>First off, some history. My first job out of College was in Common Lisp, and I love/hated it. The power it brought and the pain it brought were both one and the same. No modern libraries, no modern build tools (this was before <a href="https://www.quicklisp.org/beta/">QuickLisp</a>). One on hand, I <em>loved</em> working with paredit and Emacs, being able to quickly fly about my code and manipulate it in blocks rather than line by line. On the other, I couldn&#8217;t help but be envious of those who could actually ask for help from a functioning open source community.</p>

<p>A few years of Python, Ruby, and Javascript later, I found Clojure. And I thought I&#8217;d found the solution to literally all of the things. Paredit works again? Check. A thriving open source community? You got it. Deploy as a Jar rather than CL&#8217;s hilarious &#8220;dump the state of a running program and call it good&#8221; setup? Fuck. Yes.</p>

<p>And beyond the superficial things, there was a lot to love, especially coming from a more recent brush with Ruby on Rails. Clojure makes it very easy to make things <a href="https://en.wikipedia.org/wiki/Referential_transparency">referentially transparent</a>, and it tends to favor explicit calling semantics over convention (or more derisively, &#8220;magic&#8221;). This means that a Clojure code base will require more plumbing code, but that also means it&#8217;s possible to navigate to the code that does routing and understand how it works, no more having to search through your framework&#8217;s codebase just because they do dynamic method creation and method_missing magic.</p>

<p> As far as I was concerned, the editor was the only weak point for Clojure. Back when I got into Clojure Cursive was still brand new, Emacs really was the only editor that was worth using and even it had some stability and usability issues. But I assumed that continued interest would stabilize Emacs, bring Vim up to speed, and improve Cursive to the point where it would be competitive with Emacs/Vim.</p>

<p> But all was not well, and if I&#8217;d paid attention I might have noticed a few places where the core Clojure&#8217;s teams priorities didn&#8217;t seem to make much sense to me. And now that I work in Clojure professionally, I really cannot ignore them or remain silent about them any more.</p>

<p> The core Clojure team prefers green field development over improvements and bug fixes to existing code to a degree that deeply worries me. I no longer trust that any issues I find stand a chance of getting fixed, as all the bugs we&#8217;ve posted are either in limbo, or flat out rejected. Multiple members of my team have given up on posting new bugs because they have no faith that it&#8217;ll help anyone.</p>

<p> These are pretty heavy and vague accusations, so I&#8217;m gonna break this down a bit to make it clearer and easier to digest.</p>

<h2>Ignorance or Apathy of Underlying Principles</h2>

<p> Programming isn&#8217;t math per-se, especially in a language that&#8217;s not explicitly based on Category or Type theory. That said a lot of the things that we do are backed or defined by mathematics, and to ignore that is to guarantee bugs. This is most clear in clojure.set which contains functions that are supposed to mirror the definitions created by Set Theory like <code>union</code>, <code>difference</code>, <code>intersection</code>, etc.</p>

<p> And the namespace is completely riddled with bugs. <code>union</code> returns duplicates if some of the inputs are lists instead of sets <em>depending on their length</em>. <code>intersection</code> will either return nonsense values or throw a ClassCastException if you provide it anything other than sets, again dependent on data.</p>

<p>On their own, this is no big deal. Bugs happen, there&#8217;s really no point in berating people just because they made a mistake. Instead the bug gets fixed as best and as soon as reality allows and we all move on. In fact, for the above bugs there are two possible fixes: raise an IllegalArgumentException if anything other than sets are provided, or coerce lists and vectors to sets before continuing. Both of these approaches are valid due to the fact that this is a dynamic language that defaults to immutable collection semantics; which one you pick is then a matter of how you want to affect your downstream users.</p>

<p>Oh wait, some of these bugs were filed in <em>2009</em>, 7 fucking years ago! Here comes the berating. These functions are <strong>tiny</strong>, a simple implementation of <code>union</code> is one line. And while they&#8217;re heavily used, they&#8217;re simple in usage and signature; no need to change a lot of call sites to fix this bug. There are only two reasons to explain why these bugs have not been fix; they either do not understand that this is an issue, or they do not care.</p>

<p>Actually, their comments on the issues lets us know that they do not understand that this is an issue. Rich Hickey said in 2009 &#8220;the fact that these functions happen to work when the second argument is not a set is an implementation artifact and not a promise of the interface&#8221;. How you define getting the wrong type with nonsense values counts as &#8220;working&#8221; is beyond me. Is it just because it doesn&#8217;t throw an Exception? Anyone here prefer bad data instead of exceptions when dealing with functions like this? I doubt it.</p>

<h2>Inconsistency Between Best Practices and Clojure Implementation</h2>

<p>Clojure includes a pretty powerful concept called protocols. Basically a protocol is an interface that can be added to classes after the fact, and lets you dispatch to different behavior silently at run time.</p>

<p>This is pretty neat, it lets you abstract over multiple data types and include Java classes in the fun. For example ISeq provides all the methods needed to iterate over a collection and it works with all the Clojure and Java data types. So you can use Clojure&#8217;s <code>map</code> function over its own data types and Java&#8217;s because it depends on the seq interface.</p>

<p>As you can imagine, this is the recommended way to work with things. Rather than having to do <code>cond</code> or <code>if</code> logic on various classes, define and use an appropriate protocol and you&#8217;re good to go!</p>

<p>It sounds like a good theory doesn&#8217;t it? But Clojure itself doesn&#8217;t actually do this. Clojure.core contains 89 calls to <code>instance?</code> in order to check runtime type, instead of the helper methods to check for protocol implementation.</p>

<p><a href="http://dev.clojure.org/jira/browse/CLJ-1944">Here</a> is a bug found by my colleague that highlights this issue. List and Vector are both seqs, but <code>into</code> for a map only accepts vectors, lists causes a ClassCastException. This is kind of nuts because an IllegalArgumentException makes more sense, and there&#8217;s no practical reason to differentiate between a list of two elements and a vector of two elements. Actually, Clojure considers <code>[1 2]</code> and <code>(list 1 2)</code> to be equal, so this really makes no sense</p>

<p>Even more obnoxious, it was closed as wontfix. Apparently a single sentence in the docs is good enough for the Clojure team, as well as a paper-thin argument about performance on a 2 element list. So not only is this just broken in a barely documented and very surprising way, Clojure itself ends up programmed in a way that isn&#8217;t recommended by the Clojure docs.</p>

<p>This has spread to other projects. <a href="https://github.com/omcljs/om">Om</a> has a bug where lists aren&#8217;t acceptable in its data structures, only maps sets and vectors. To say that I was treated pretty <a href="https://github.com/omcljs/om/issues/246">shabbily</a> by David Nolen on this issue almost goes without saying. Naturally the intro <a href="https://github.com/omcljs/om/wiki/Basic-Tutorial">docs</a> barely call this out, and the docs <a href="https://github.com/omcljs/om/wiki/Cursors">dedicated</a> to the troubled component does not mention this at all. To be fair, the <a href="https://github.com/omcljs/om/wiki/Troubleshooting">troubleshooting guide</a> explains this, but in my opinion that&#8217;s probably a clue that the bug is common enough that you should find a fix for it.</p>

<h2>Show Stopping Bugs Remain Untouched</h2>

<p>There are a shocking number of big, bad bugs hiding in the Clojure Jira, some really old</p>

<ul>
<li><a href="http://dev.clojure.org/jira/browse/CLJ-308">This one</a> about fixing with-open for Clojure defined stuff provided a patch 5 years ago.</li>
<li><a href="http://dev.clojure.org/jira/browse/CLJ-440">Calling VarArgs Successfully</a> from 6 years ago.</li>
<li><a href="http://dev.clojure.org/jira/browse/CLJ-700">Contains? broken for transient collections</a> from 5 years ago. But it&#8217;s due for this version, so cross your fingers!</li>
<li><a href="http://dev.clojure.org/jira/browse/CLJ-1463">Bizarrely Defensive Response</a> for a minor code review.</li>
<li><a href="http://dev.clojure.org/jira/browse/CLJ-1741">Duelling ClassLoaders</a> first discovered last year. This one breaks our editors constantly. Not even assigned.</li>
</ul>


<p>I could go on, but I feel that I&#8217;ve made my point. Bugs, even major ones are either closed as &#8220;wontfix&#8221;, or are ignored for years despite the pain felt by users. That&#8217;s not even covering the dismissive and distrustful attitude given in some of the replies.</p>

<h2>Strange Priorities</h2>

<p>The Clojure team appears to be super focused on new features, at the exclusion of existing namespaces. The big highlights from the past year or so have been Transit, Transducers, and Spec.</p>

<p>These are okay, I guess. We use transit a bit, and it&#8217;s kinda cool. But we really don&#8217;t use 90% of its features, it&#8217;s basically JSON for us that can convert numbers to BigDecimals.</p>

<p>We have yet to find a place that Transducers would help us. They&#8217;re neat enough, but the built in lazy sequences are working A-OK for us, so we don&#8217;t really feel the need to change over.</p>

<p>I&#8217;m not holding my breath for Spec. It doesn&#8217;t fix anything for me that other libraries aren&#8217;t already providing.</p>

<p>Know what hasn&#8217;t seen any major improvements in forever? Clojure.test. Clojure.Test is frankly sad. Fixtures are done via some global state, and you can&#8217;t even setup fixtures to work across the entire test suite. Need a database to run functional tests? Well either you need to override the main test runner (good luck running individual tests now!) or you have to setup each namespace to open and close its own database connection (don&#8217;t forget, or your DBA will wonder why Emacs has 1000+ database connections). I&#8217;m 100% behind the idea that I&#8217;ll have to write a bit of glue code, but without anywhere to <em>put</em> that code I&#8217;m kind of screwed.</p>

<p>And then there is the <code>is</code> function. It&#8217;s literally the only assertion provided by clojure.test. It&#8217;s this fancy little macro that grabs its body, evaluates it, then uses the body to produce a human readable message about the failure.</p>

<p>And it&#8217;s garbage. The fact that <a href="https://github.com/pjstadig/humane-test-output">plugins</a> exist to make this easier on the eyes should tell you everything you need to know. Oh but don&#8217;t use that with Emacs/Cider! It&#8217;ll crash the Cider plugin, which is trying to parse the default output.</p>

<p>Back when I used Emacs, I had a stash on my box that disabled AOT, pedantic checking, and the humane-test-output plugin from my project.clj in order to use Cider. Without that stash applied Cider wouldn&#8217;t start, couldn&#8217;t reload code, and would crash when running tests. Now that I use Cursive that&#8217;s less of an issue, but it&#8217;s still kind of nuts I had to decide between a working editor and readable output when I ran <code>lein test</code></p>

<p>Sorry, I didn&#8217;t even highlight the craziest bit of that last paragraph, did you catch it? I had to disable humane-test-output from my <em>project.clj</em>. That&#8217;s because you install it by injecting some code in project.clj that <strong>redefines</strong> some multi-methods, because there&#8217;s no plugin architecture. How nuts is that?</p>

<p>Now I might hear you say &#8220;You don&#8217;t have to use clojure.test!&#8221;, and you&#8217;re right. But clojure.test has clearly won in the Clojure testing namespace. The only real competitors for clojure.test are <a href="https://github.com/slagyr/speclj">Speclj</a> and <a href="https://github.com/marick/Midje">Midje</a>. I&#8217;ve literally never met someone in person that&#8217;s used Speclj, and Midje is super polarizing because it&#8217;s basically a collection of magic macros. The fact that the second entry for Midje is about CircleCI rewriting from Midje to clojure.test should tell you a lot.</p>

<p>So why don&#8217;t we have more creature comforts for clojure.test? I&#8217;m not really sure. As far as I can tell the change to it was the inclusion of <a href="https://github.com/clojure/test.check">test.check</a>, but that really was nothing more than simple-check getting renamed and transferred to Clojure ownership.</p>

<h1>Okay, Now What?</h1>

<p>As I stated before, this isn&#8217;t a &#8220;I&#8217;m quitting Clojure!&#8221; post. Partly this is because I work in Clojure on a daily basis, and I both like my job and am professional enough to keep working despite my complaints. And partly this is because I do not have a replacement for Clojure in mind for my own personal projects. But off the top of my head, there are the things I&#8217;d like to see fixed in the Clojure areas.</p>

<ul>
<li>More love for clojure.test.</li>
<li>No tolerance for bugs that result in bad-data. Built in functions should either work, or throw an understandable exception.</li>
<li>Friendlier responses in Jira. Someone who has gone to the work to sign up and try to help out should be treated with more respect.</li>
<li>Fix underlying compiler bugs before adding features. The other way only codifies bad behavior and guarantees that it cannot be fixed.</li>
<li>Understand that if enough people have the same issue, it&#8217;s the codes fault and a FAQ entry is <strong>not</strong> good enough.</li>
</ul>


<p>Basically I want Clojure to be a simple to use language backed by a friendly and active community. What I see now is drifting in the wrong direction, and I&#8217;d like to see that corrected.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/25/integrating-test-dot-check-and-javascript/">Integrating Test.Check and Javascript</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-25T08:41:00-07:00" pubdate data-updated="true">Sep 25<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Introduction</h1>

<p>I was recently on
<a href="http://blog.cognitect.com/cognicast/ashton-kemerling-064">The Cognicast</a>
with Craig Andera where we discussed using Generative Testing on a large
non-Clojure(script) codebase, in particular Ruby on Rails and
Backbonejs. If you haven&#8217;t listened to the show yet I highly recommend
it first.</p>

<p>As I promised on the show, I&#8217;d like to share how we used Test.Check to
test our Backbone.js code base. Our overall strategy for testing
Javascript is going to be:</p>

<ol>
<li>Compile JS into one file (just like prod).</li>
<li>Compile tests into a single file.</li>
<li>Combine them in a PhantomJS process.</li>
<li>Let the tests do their thing.</li>
</ol>


<p>While we have been super pleased with the results of Generative Testing,
there have been some hurdles for getting it to work for us. In this post
I&#8217;m going to go over how to setup Test.Check to work with your
Javascript app, and how to dodge all the pitfalls I found.</p>

<p>Here are the challenges that lie between us and Generative Testing bliss.</p>

<ol>
<li>Picking the right library</li>
<li>Setting up Leiningen &amp; Cljsbuild</li>
<li>Dodge PhantomJS issues</li>
<li>Avoid mangling your app, and defeating dueling dependencies</li>
</ol>


<h1>Picking the Right Library</h1>

<p>First of all, there are two libraries that exist,
<a href="https://github.com/clojure/test.check">Test.Check</a> and
<a href="https://github.com/cemerick/double-check">DoubleCheck</a>. Because
Test.Check is an official Clojure library it is Clojure (JVM) only, so I
recommend DoubleCheck (maintained by Chas Emerick) which is capable of
cross compiling to Clojure and Clojurescript.</p>

<p>The only catch with DoubleCheck is that it&#8217;s not currently possible to
segregate tests via metadata for running in groups. But with the way we
will be running these tests that won&#8217;t be an issue.</p>

<h1>Setting up Leiningen</h1>

<p>First step, install <a href="http://leiningen.org/">Leiningen</a> and create a
project.clj wherever you Javascript code is. We&#8217;re going to use
<a href="https://github.com/emezeske/lein-cljsbuild">Cljsbuild</a> to compile our
testing code for execution. I in put my test code in test/cljs (because
I have clj and cljs based tests), and send the compiled output to
tmp/tracker-cljs.js. Note: this guide <em>only works for Clojurescript
0.0-2234</em>, I need to figure out why the latest build of Clojurescript
doesn&#8217;t work.</p>

<p>I highly recommend you send the output of the compilation process to
either a temporary or gitignored location. The output will be fairly
large, and it will bog down your repository with its size.</p>

<p>I don&#8217;t want to duplicate the Cljsbuild how-to, so if you don&#8217;t know how
to make it work, you should check their docs. Our project.clj is
reproduced at the bottom of this post if you have issues.</p>

<p>At this point, we can write the simplest test possible:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">tracker-cljs.simple-test</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.test.check</span> <span class="ss">:as</span> <span class="nv">core</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.test.check.generators</span> <span class="ss">:as</span> <span class="nv">gen</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.test.check.properties</span> <span class="ss">:as</span> <span class="nv">prop</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">cemerick.cljs.test</span> <span class="ss">:as</span> <span class="nv">t</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require-macros</span> <span class="p">[</span><span class="nv">clojure.test.check.clojure-test</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">defspec</span><span class="p">)]</span>
</span><span class='line'>                   <span class="p">[</span><span class="nv">clojure.test.check.properties</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">for-all</span><span class="p">)]</span>
</span><span class='line'>                   <span class="p">[</span><span class="nv">cemerick.cljs.test</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">is</span><span class="p">)]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defspec</span> <span class="nv">simple-test</span> <span class="mi">10</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">for-all</span> <span class="p">[</span><span class="nv">v</span> <span class="p">(</span><span class="nf">gen/such-that</span> <span class="nv">gen/not-empty</span> <span class="p">(</span><span class="nf">gen/vector</span> <span class="nv">gen/int</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">println </span><span class="nv">v</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">true</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h1>PhantomJS issues.</h1>

<p>In order to run the tests, you would typically have a :tests section in
:cljsbuild that looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="ss">:test-commands</span> <span class="p">{</span><span class="s">&quot;unit-tests&quot;</span> <span class="p">[</span><span class="s">&quot;phantomjs&quot;</span> <span class="ss">:runner</span>
</span><span class='line'>                                          <span class="s">&quot;compiled-application.js&quot;</span>
</span><span class='line'>                                          <span class="s">&quot;tmp/compiled-tests.js&quot;</span><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will load our JS into the app, along with the tests, and then run
them. But you might notice errors that look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">SECURITY_ERR</span><span class="err">:</span> <span class="nv">DOM</span> <span class="nv">Exception</span> <span class="mi">18</span><span class="err">:</span> <span class="nv">An</span> <span class="nv">attempt</span> <span class="nv">was</span> <span class="nv">made</span> <span class="nv">to</span> <span class="nv">break</span> <span class="nv">through</span> <span class="nv">the</span> <span class="nv">security</span> <span class="nv">policy</span> <span class="nv">of</span> <span class="nv">the</span> <span class="nv">user</span> <span class="nv">agent.</span>
</span></code></pre></td></tr></table></div></figure>


<p>That means that your app code is trying to access local storage, and
PhantomJS does not like it when you do that without loading a
webpage. The solution for this is to start a server so we have a page to
visit, and visit it via PhantomJS. So on Tracker we use the following
two bits of code.</p>

<p>generative_runner.js, to visit the actual page:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">//</span> <span class="nv">reusable</span> <span class="nv">PhantomJS</span> <span class="nv">script</span> <span class="nb">for </span><span class="nv">running</span> <span class="nv">clojurescript.test</span> <span class="nv">tests</span>
</span><span class='line'><span class="nv">//</span> <span class="nv">see</span> <span class="nv">http</span><span class="ss">://github.com/cemerick/clojurescript.test</span> <span class="nb">for </span><span class="nv">more</span> <span class="nv">info</span>
</span><span class='line'>
</span><span class='line'><span class="k">var </span><span class="nv">page</span> <span class="nb">= </span><span class="nv">require</span><span class="p">(</span><span class="ss">&#39;webpage</span><span class="o">&#39;</span><span class="p">)</span><span class="nv">.create</span><span class="p">()</span><span class="c1">;</span>
</span><span class='line'><span class="nv">page.onResourceError</span> <span class="nb">= </span><span class="nv">function</span><span class="p">(</span><span class="nf">resourceError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">page.reason</span> <span class="nb">= </span><span class="nv">resourceError.errorString</span><span class="c1">;</span>
</span><span class='line'>    <span class="nv">page.reason_url</span> <span class="nb">= </span><span class="nv">resourceError.url</span><span class="c1">;</span>
</span><span class='line'><span class="p">}</span><span class="c1">;</span>
</span><span class='line'><span class="k">var </span><span class="nv">fs</span> <span class="nb">= </span><span class="nv">require</span><span class="p">(</span><span class="ss">&#39;fs</span><span class="o">&#39;</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'><span class="k">var </span><span class="nv">sys</span> <span class="nb">= </span><span class="nv">require</span><span class="p">(</span><span class="ss">&#39;system</span><span class="o">&#39;</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'><span class="k">var </span><span class="nv">success</span><span class="c1">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">page.onConsoleMessage</span> <span class="nb">= </span><span class="nv">function</span> <span class="p">(</span><span class="nf">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var </span><span class="nv">line</span> <span class="nb">= </span><span class="nv">x.toString</span><span class="p">()</span><span class="c1">;</span>
</span><span class='line'>    <span class="k">if </span><span class="p">(</span><span class="nf">line</span> <span class="nv">!==</span> <span class="s">&quot;[NEWLINE]&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">sys.stdout.writeLine</span><span class="p">(</span><span class="nf">line.replace</span><span class="p">(</span><span class="nf">/</span><span class="sc">\[</span><span class="nv">NEWLINE</span><span class="sc">\]</span><span class="nv">/g</span>, <span class="s">&quot;\n&quot;</span><span class="p">))</span><span class="c1">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="c1">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">page.open</span><span class="p">(</span><span class="ss">&#39;http://localhost:4500</span><span class="o">&#39;</span>, <span class="nv">function</span><span class="p">(</span><span class="nf">status</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if </span><span class="p">(</span><span class="nf">status</span> <span class="nv">!==</span> <span class="s">&quot;success&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">console.log</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t load page&quot;</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'>        <span class="nv">phantom.exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nb">for </span><span class="p">(</span><span class="k">var </span><span class="nv">i</span> <span class="nb">= </span><span class="mi">1</span><span class="c1">; i &lt; sys.args.length; i++) {</span>
</span><span class='line'>        <span class="k">if </span><span class="p">(</span><span class="nf">fs.exists</span><span class="p">(</span><span class="nf">sys.args</span><span class="p">[</span><span class="nv">i</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if </span><span class="p">(</span><span class="nf">!page.injectJs</span><span class="p">(</span><span class="nf">sys.args</span><span class="p">[</span><span class="nv">i</span><span class="p">]))</span> <span class="nv">throw</span> <span class="k">new </span><span class="nv">Error</span><span class="p">(</span><span class="s">&quot;Failed to inject &quot;</span> <span class="nb">+ </span><span class="nv">sys.args</span><span class="p">[</span><span class="nv">i</span><span class="p">])</span><span class="c1">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="nv">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">page.evaluateJavaScript</span><span class="p">(</span><span class="s">&quot;(function () { &quot;</span> <span class="nb">+ </span><span class="nv">sys.args</span><span class="p">[</span><span class="nv">i</span><span class="p">]</span> <span class="nb">+ </span><span class="s">&quot;;&quot;</span> <span class="nb">+ </span><span class="s">&quot; })&quot;</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">page.evaluate</span><span class="p">(</span><span class="nf">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">cemerick.cljs.test.set_print_fn_BANG_</span><span class="p">(</span><span class="nf">function</span><span class="p">(</span><span class="nf">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">console.log</span><span class="p">(</span><span class="nf">x.replace</span><span class="p">(</span><span class="nf">/</span><span class="sc">\n</span><span class="nv">/g</span>, <span class="s">&quot;[NEWLINE]&quot;</span><span class="p">))</span><span class="c1">; // since console.log *itself* adds a newline</span>
</span><span class='line'>        <span class="p">})</span><span class="c1">;</span>
</span><span class='line'>    <span class="p">})</span><span class="c1">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">success</span> <span class="nb">= </span><span class="nv">page.evaluate</span><span class="p">(</span><span class="nf">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">var </span><span class="nv">results</span> <span class="nb">= </span><span class="nv">cemerick.cljs.test.run_all_tests</span><span class="p">()</span><span class="c1">;</span>
</span><span class='line'>        <span class="nv">console.log</span><span class="p">(</span><span class="nf">results</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'>        <span class="nv">return</span> <span class="nv">cemerick.cljs.test.successful_QMARK_</span><span class="p">(</span><span class="nf">results</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'>    <span class="p">})</span><span class="c1">;</span>
</span><span class='line'>    <span class="nv">phantom.exit</span><span class="p">(</span><span class="nf">success</span> <span class="nv">?</span> <span class="mi">0</span> <span class="err">:</span> <span class="mi">1</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'><span class="p">})</span><span class="c1">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And a rake task to stand up a server and run everything. If you don&#8217;t
use Rails for your Javascript code you might need to use different
commands to compile, but the intention remains. The WEBrick server
provides a blank page for us to visit and run our tests on, which
prevents PhantomJS from raising security errors.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">require</span> <span class="ss">&#39;fileutils</span><span class="o">&#39;</span>
</span><span class='line'><span class="nv">require</span> <span class="ss">&#39;webrick</span><span class="o">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">namespace </span><span class="ss">:test</span> <span class="nv">do</span>
</span><span class='line'>  <span class="nv">desc</span> <span class="s">&quot;Run ClojureScript generative tests&quot;</span>
</span><span class='line'>  <span class="nv">task</span> <span class="ss">:generative</span> <span class="nv">do</span>
</span><span class='line'>    <span class="nv">server</span> <span class="nb">= </span><span class="nv">WEBrick</span><span class="ss">::HTTPServer.new</span><span class="p">({</span><span class="ss">:Port</span> <span class="nv">=&gt;</span> <span class="mi">4500</span>, <span class="ss">:DocumentRoot</span> <span class="nv">=&gt;</span> <span class="s">&quot;.&quot;</span>, <span class="ss">:BindAddress</span> <span class="nv">=&gt;</span> <span class="s">&quot;0.0.0.0&quot;</span><span class="p">})</span>
</span><span class='line'>    <span class="nv">Thread.new</span> <span class="nv">do</span>
</span><span class='line'>      <span class="nv">server.start</span>
</span><span class='line'>    <span class="nv">end</span>
</span><span class='line'>    <span class="nv">exitCode</span> <span class="nb">= </span><span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">begin</span>
</span><span class='line'>      <span class="nv">Rake</span><span class="ss">::Task</span><span class="p">[</span><span class="ss">&#39;assets:clean</span><span class="o">&#39;</span><span class="p">]</span><span class="nv">.invoke</span>
</span><span class='line'>      <span class="nv">Rake</span><span class="ss">::Task</span><span class="p">[</span><span class="ss">&#39;assets:precompile</span><span class="o">&#39;</span><span class="p">]</span><span class="nv">.invoke</span>
</span><span class='line'>      <span class="nv">exitCode</span> <span class="nb">= </span><span class="nv">system</span> <span class="s">&quot;lein cljsbuild test&quot;</span>
</span><span class='line'>    <span class="nv">ensure</span>
</span><span class='line'>      <span class="nv">server.shutdown</span>
</span><span class='line'>    <span class="nv">end</span>
</span><span class='line'>    <span class="nv">exit</span> <span class="nv">exitCode</span>
</span><span class='line'>  <span class="nv">end</span>
</span><span class='line'><span class="nv">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To make all this work together, update project.clj to reference the
generative_runner.js file instead of :runner, and use <code>rake
test:generative</code> to kick off the run.</p>

<h1>Don&#8217;t Mangle Your Code</h1>

<p>If your application is anything like Tracker, you might use some Google
Closure dependencies without using the entire Closure compiler. And even
if you don&#8217;t need use Closure, you certainly have functions and classes
in the global namespace that you don&#8217;t want mangled.</p>

<p>To get around this, I recommend the following settings:</p>

<p>Add <code>:libs [ "compiled-application.js" ""]</code> to the cljsbuild section
in project.clj. This prevents DoubleCheck compiler errors due to
classpath issues, and it allows the Closure compiler to see everything
that your application provides. So if your tests and applications have
overlapping Closure dependencies you won&#8217;t get double provide errors.</p>

<p>Secondly I recommend that you only use the simple compilation mode. This
will prevent Closure from mangling global names, which will make
debugging easier and prevent your tests from being able to find the
production code. The space saving and code elimination that advanced
mode provides is more of a problem than a benefit for testing, so it&#8217;s
not worth fighting to get advanced to work.</p>

<p>You can fiddle with source maps if you wish, but I
haven&#8217;t had much luck or use for them; simple compiled Clojurescript is
easy to read, and most of the serious errors have come from the 43k
application javascript file, not the test file.</p>

<h1>Have Fun and Make More Tests</h1>

<p>Once you have that going, it should be possible to open up and create
increasingly complicated tests. As a teaser and a good example, the
following code caught a tricky JS ordering bug.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">tracker-cljs.panel-items-test</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.test.check</span> <span class="ss">:as</span> <span class="nv">core</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.test.check.generators</span> <span class="ss">:as</span> <span class="nv">gen</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.test.check.properties</span> <span class="ss">:as</span> <span class="nv">prop</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">cemerick.cljs.test</span> <span class="ss">:as</span> <span class="nv">t</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require-macros</span> <span class="p">[</span><span class="nv">clojure.test.check.clojure-test</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">defspec</span><span class="p">)]</span>
</span><span class='line'>                   <span class="p">[</span><span class="nv">clojure.test.check.properties</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">for-all</span><span class="p">)]</span>
</span><span class='line'>                   <span class="p">[</span><span class="nv">cemerick.cljs.test</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">is</span><span class="p">)]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">ids</span> <span class="p">[</span><span class="nv">items</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">seq? </span><span class="nv">items</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">item</span><span class="p">]</span> <span class="p">(</span><span class="nf">.get</span> <span class="nv">item</span> <span class="ss">:id</span><span class="p">))</span>
</span><span class='line'>         <span class="nv">items</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">item</span><span class="p">]</span> <span class="p">(</span><span class="nf">.get</span> <span class="nv">item</span> <span class="ss">:id</span><span class="p">))</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">.-models</span> <span class="nv">items</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">create-models</span> <span class="p">[</span><span class="nv">ids</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">x</span><span class="p">]</span> <span class="p">(</span><span class="nf">Backbone.Model.</span> <span class="p">(</span><span class="nf">js-obj</span> <span class="ss">:id</span> <span class="nv">x</span><span class="p">)))</span>
</span><span class='line'>       <span class="nv">ids</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defspec</span> <span class="nv">sort-check</span> <span class="mi">100</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">for-all</span> <span class="p">[</span><span class="nv">v</span> <span class="p">(</span><span class="nf">gen/such-that</span> <span class="nv">gen/not-empty</span> <span class="p">(</span><span class="nf">gen/vector</span> <span class="nv">gen/int</span><span class="p">))]</span>
</span><span class='line'>           <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">models</span> <span class="p">(</span><span class="nf">create-models</span> <span class="nv">v</span><span class="p">)</span>
</span><span class='line'>                 <span class="nv">sorted</span> <span class="p">(</span><span class="nb">sort </span><span class="nv">v</span><span class="p">)</span>
</span><span class='line'>                 <span class="nv">subject</span> <span class="p">(</span><span class="nf">tracker.PanelItems.</span><span class="p">)]</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">.reset</span> <span class="nv">subject</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">array</span> <span class="nv">models</span><span class="p">))</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">.refresh</span> <span class="nv">subject</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">array</span> <span class="p">(</span><span class="nb">sort-by </span><span class="o">#</span><span class="p">(</span><span class="nf">.get</span> <span class="nv">%</span> <span class="ss">:id</span><span class="p">)</span> <span class="nv">models</span><span class="p">)))</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nb">= </span><span class="nv">sorted</span>
</span><span class='line'>                    <span class="p">(</span><span class="nf">ids</span> <span class="nv">subject</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the following is our project.clj, with unnecessary details elided
for readability.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">generative-testing</span> <span class="s">&quot;0.0.1-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-cljsbuild</span> <span class="s">&quot;1.0.3&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">com.cemerick/clojurescript.test</span> <span class="s">&quot;0.2.2&quot;</span><span class="p">]]</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojurescript</span> <span class="s">&quot;0.0-2234&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">com.cemerick/clojurescript.test</span> <span class="s">&quot;0.3.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">com.cemerick/double-check</span> <span class="s">&quot;0.5.8-SNAPSHOT&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]]</span>
</span><span class='line'>  <span class="ss">:cljsbuild</span> <span class="p">{</span><span class="ss">:builds</span> <span class="p">[{</span><span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;test/cljs&quot;</span><span class="p">]</span>
</span><span class='line'>                        <span class="ss">:compiler</span> <span class="p">{</span><span class="ss">:output-to</span> <span class="s">&quot;tmp/tracker-cljs.js&quot;</span>
</span><span class='line'>                                   <span class="ss">:libs</span> <span class="p">[</span> <span class="s">&quot;public/web/assets/application.js&quot;</span> <span class="s">&quot;&quot;</span><span class="p">]</span>
</span><span class='line'>                                   <span class="ss">:optimizations</span> <span class="ss">:simple</span>
</span><span class='line'>                                   <span class="ss">:pretty-print</span> <span class="nv">true</span><span class="p">}}]</span>
</span><span class='line'>              <span class="ss">:test-commands</span> <span class="p">{</span><span class="s">&quot;unit-tests&quot;</span> <span class="p">[</span><span class="s">&quot;phantomjs&quot;</span> <span class="s">&quot;lib/generative_runner.js&quot;</span>
</span><span class='line'>                                            <span class="s">&quot;public/next/assets/next/next.js&quot;</span>
</span><span class='line'>                                            <span class="s">&quot;tmp/tracker-cljs.js&quot;</span><span class="p">]}})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also, the following function is helpful for converting from Cljs data
structures to pure Javascript ones. It causes some compiler warnings,
but they appear to be harmless.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">clj-&gt;js</span>
</span><span class='line'>  <span class="s">&quot;Recursively transforms ClojureScript maps into Javascript objects,</span>
</span><span class='line'><span class="s">   other ClojureScript colls into JavaScript arrays, and ClojureScript</span>
</span><span class='line'><span class="s">   keywords into JavaScript strings.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">x</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">cond</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">string? </span><span class="nv">x</span><span class="p">)</span> <span class="nv">x</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">keyword? </span><span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">name </span><span class="nv">x</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">map? </span><span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">js-obj</span> <span class="p">(</span><span class="nf">flatten</span> <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nb">key </span><span class="nv">val</span><span class="p">]]</span> <span class="p">[(</span><span class="nf">clj-&gt;js</span> <span class="nv">key</span><span class="p">)</span> <span class="p">(</span><span class="nf">clj-&gt;js</span> <span class="nv">val</span><span class="p">)])</span> <span class="nv">x</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">coll?</span> <span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">array</span> <span class="p">(</span><span class="nb">map </span><span class="nv">clj-&gt;js</span> <span class="nv">x</span><span class="p">))</span>
</span><span class='line'>    <span class="ss">:else</span> <span class="nv">x</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Good luck, and don&#8217;t hesitate to reach out to me on Twitter if you have
any questions!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/19/unusual-productivity-hacks/">Unusual Productivity Hacks</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-19T07:37:00-07:00" pubdate data-updated="true">Jun 19<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The internet is lousy with productivity ideas, mostly about how to work harder or longer. I personally believe that good productivity is about maximizing per hour results, not working harder. And the fastest way to improve your productivity is to eliminate some of the things slowing you down. So rather than going over the usual suspects, let&#8217;s take a look at eliminating some of the low hanging fruit.</p>

<h2>1. Conquer Your Diet.</h2>

<p>What you eat is the cornerstone of who you are and what you do. The proteins in your muscle, the fats in your cell walls and your brain, and the amino acids used throughout your body must all come from, or be synthesized from your food. Low quality food products like trans fats have been connected with apathy, depression, and might be related to ADD. In order for your brain and body to perform at peak levels you need to give it high quality food to repair and refuel.</p>

<h2>2. Sleep</h2>

<p>Sleep is massively underrated. Everyone knows at this point that Americans are typically not getting enough sleep on a nightly basis, but distressingly few people consider it to be an issue. After all, hours spent asleep aren&#8217;t hours spent working right? Unfortunately it isn&#8217;t that simple. Insufficient or low quality sleep is one of the fastest ways that we know of to destroy per hour productivity. Get sleep or waste your precious waking hours in a mind fog.</p>

<h2>3. Know when to stop.</h2>

<p>Athletes regularly destroy their bodies by &#8220;over training&#8221;; exercising to the point of injury or chronic fatigue. The results of over training are often slow growth or even frustrating setbacks despite hundreds of hours at the gym or on the track.</p>

<p>Mental workers regularly do the exact same thing to their mind by working well past the point of mental burnout. There is very little use in working when you are not going to be putting out at least average results, and you risk ruining your morale after hours of low-results work. Instead of ritualistically working even when you are spent gain an intuitive sense for when you will accomplish little and instead go recharge and try again later.</p>

<h2>4. You must come out unharmed 1 time or 1000 times.</h2>

<p>No productivity regime is worthwhile if you can only maintain it for 2 weeks at the start of each year. To be successful, you must find a pattern that you can maintain years. Whether that is a small amount per day or a cycle between intense work and relaxation, you must find a balance between work and play or you will be plagued by failures to meet your goals.</p>

<h2>5. Know thyself.</h2>

<p>Everyone wants to be successful, but most people overestimate how much money motivates them. Find ways to motivate yourself with something other than riches, or better yet find something that you love to do. Love of the work will make it easier to get up, or home, every day and work rather than abstract future financial rewards.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/09/the-swordsman-and-the-software-engineer/">The Swordsman and the Software Engineer</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-09T22:31:00-07:00" pubdate data-updated="true">Jun 9<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the largest mistakes you can make as a knowledge worker is to focus 100% of your time on your craft. It&#8217;s easy to believe that specializing and focusing will make you better than your peers, but I do not think that is the case. Not only will specializing cause you to plateau earlier than your peers, it will cause you to be less happy and healthy than your diversified peers.</p>

<p>A bit of background at this point would probably be helpful. I&#8217;m a software engineer and I&#8217;ve coded both professionally and on a hobbyist basis for nearly a decade. After a particularly stressful few months at a previous job, my fiancé forced me to join a local gym to de-stress. The gym focused on various European martial arts and I ended up in a class for the Italian longsword circa 1409.</p>

<p>A few years ago I would have suspected that choosing to surrender 2-8 hours a week to swinging steel around instead of programming on hobbyist projects would slow down my growth. Now I believe that I owe a lot of my growth, professionally and as a human being to this practice. A lot of what I&#8217;m going to cover here will probably be old news to anyone who was heavily involved in sports, nor is it particularly unique to fencing. That being said I&#8217;m fairly confident that a lot of knowledge workers have lost the involvement with physical activities they might have had, or never were all that &#8220;athletic&#8221; even in school.</p>

<p>The biggest modern challenge is that humans are not wired for the type of work that we now do. We are a fairly clever species by nature, which is why we have been making art for hundreds of thousands of years. But we are still more or less genetically and mentally hunter gatherers from 100,000+ years ago who largely worked for their survival. Our bodies, genes, and minds are wired to expect a specific ratio of play and physical activity to signal that all is well. Unfortunately we work a lot longer than our ancestors did, and under very different conditions.</p>

<p>This high level of nothing but work, physical or mental, indicates to our bodies that times are tough and that it should release stress hormones to help us survive the coming hard times; these stress hormones tend to have serious detrimental effects on mental performance and long term health. The phrase &#8220;all work and no play&#8221; may be over-used, but it does have some truth. All work and no play leaves Jack pumped full of cortisol, short on sleep, and low on testosterone.</p>

<p>Secondly, most knowledge workers spend their entire time thinking only with their frontal cortex, or the analytical portion of the brain. This is very helpful if your job involves concentrating on difficult problems all day, but it is incredibly easy to let that portion of your brain become the only driving factor on your day to day life. The brain, like your muscles, should have ample opportunity to exercise all of its faculties and have recovery time between each heavy usage. Expecting it to be able to focus deeply on your work day in and day out without giving it time to relax is simply asking for lowered performance and burnout, and only working on one aspect of your mental performance is akin to only doing curls at the gym; the result is an odd shape with very little practical strength.</p>

<p>Thankfully exercise and hobbies help other parts of the brain. This is one of the things I love about fencing: it isn&#8217;t very analytical once you actually start using it. There are a ton of cuts and guards to be memorized, but you never have time to think about it when you are actually fencing. All of the drills are designed so that your mind and body learn to move with instinctual grace from one guard to another. There is very little conscious thought that happens mid-move in a match; there simply is not enough time to stop and think. Instead you learn to have an internalized notion of time and measure, and an ability to make new decisions as the fight progresses quickly and correctly.</p>

<p>And while none of this directly relates to software engineering, it has a positive effect on my daily work. The ability to move with a fight and think with my toes and fingertips have given me a greater appreciation to the importance of gut instinct in more situations. And the constant practice of excluding my analytical mind in a fast moving match have improved my ability to enter a flow state more easily. Combine these things with the general good effects of mental down time and exercise, and I think it&#8217;s hard to argue that my time would have been better spent working on hobbyist projects.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/28/confessions-of-a-language-snob/">Confessions of a Language Snob</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-28T22:29:00-07:00" pubdate data-updated="true">May 28<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I am a language snob. In particular I fall head over heels for most functional languages, especially MLs and Lisps. Show me the latest and greatest Javascript framework and I will just wish I had immutable data types and a saner method dispatch system. I try to keep quiet about it at work with varying degrees of success, but it&#8217;s frustrating to work around one language&#8217;s problems when you know of other solutions.</p>

<p>The difficult reality that few admit is that every language has a weak point. Ruby is slow and the lack of import semantics and proper namespaces makes it difficult to determine what code will run. Python lacks a good lambda and whitespace sensitivity brings new difficulties. Javascript is just pure insanity. Lisp is poorly standardized and tends to have subpar documentation. The list goes on and on. No language is perfect, but it&#8217;s very easy to focus on the high points of one language while working through the low points of another.</p>

<p>The real bummer about being a language snob is that there&#8217;s really nothing to be done about it. For any given issue there will always be another language that exceeds in that area, but it&#8217;s almost always insane and impractical to convert your entire company over to it. So even if you think Go would solve every problem that your Python codebase has, and you know that the downsides wouldn&#8217;t be insurmountable, the simple reality is that convincing the organization to throw away their perfectly good Python code on a whim is insane at best. And that&#8217;s assuming that converting to your language wouldn&#8217;t come with downsides worse than the language you are coming from.</p>

<p>Thankfully, there is an upside to being a language snob. Polyglots have a far more flexible understanding of what a program should do, especially when they&#8217;re used to a wide range of paradigms. Someone who has done nothing but C or Java programming might have very little context into why mutable state can be so problematic, but someone who knows Clojure or Haskell will know the tradeoffs of mutable vs. immutable state intimately. Each new paradigm a programmer embraces means that they have more internal views on how a particular problem could be solved, a bit like having an experienced team in your head to discuss the merits of various techniques at lightning speed.</p>

<p>While it may be very frustrating to know of better solutions in other languages, there is a benefit to knowing about them. Being a language snob can help you evaluate your choices more effectively and discover solutions and strategies that might not be immediately obvious if you only knew one language. And between being a bit of a snob and attempting to shoe-horn every problem into a one-size fits all paradigm, I&#8217;ll take being a snob.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Ashton Kemerling -
    <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
    <a href="https://www.totemnutrition.com"><img src="images/totem.jpg"> </a>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
