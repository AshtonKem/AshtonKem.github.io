
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Integrating Test.Check and Javascript - Ashton Kemerling</title>
  <meta name="author" content="Ashton Kemerling">

  
  <meta name="description" content="Introduction I was recently on
The Cognicast
with Craig Andera where we discussed using Generative Testing on a large
non-Clojure(script) codebase, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.ashtonkemerling.com/blog/2014/09/25/integrating-test-dot-check-and-javascript">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Ashton Kemerling" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32325955-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <h1>Ashton Kemerling</h1>
  
    <h2><a href="/">AK</a></h2>
  
</hgroup>

</header>
  <nav role="navigation">
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-me">About Me</a></li>
  <li><a href="/consulting">Consulting</a></li>
  <li><a href="/resume">Resume</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Integrating Test.Check and Javascript</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-25T08:41:00-07:00" pubdate data-updated="true">Sep 25<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><h1>Introduction</h1>

<p>I was recently on
<a href="http://blog.cognitect.com/cognicast/ashton-kemerling-064">The Cognicast</a>
with Craig Andera where we discussed using Generative Testing on a large
non-Clojure(script) codebase, in particular Ruby on Rails and
Backbonejs. If you haven&#8217;t listened to the show yet I highly recommend
it first.</p>

<p>As I promised on the show, I&#8217;d like to share how we used Test.Check to
test our Backbone.js code base. Our overall strategy for testing
Javascript is going to be:</p>

<ol>
<li>Compile JS into one file (just like prod).</li>
<li>Compile tests into a single file.</li>
<li>Combine them in a PhantomJS process.</li>
<li>Let the tests do their thing.</li>
</ol>


<p>While we have been super pleased with the results of Generative Testing,
there have been some hurdles for getting it to work for us. In this post
I&#8217;m going to go over how to setup Test.Check to work with your
Javascript app, and how to dodge all the pitfalls I found.</p>

<p>Here are the challenges that lie between us and Generative Testing bliss.</p>

<ol>
<li>Picking the right library</li>
<li>Setting up Leiningen &amp; Cljsbuild</li>
<li>Dodge PhantomJS issues</li>
<li>Avoid mangling your app, and defeating dueling dependencies</li>
</ol>


<h1>Picking the Right Library</h1>

<p>First of all, there are two libraries that exist,
<a href="https://github.com/clojure/test.check">Test.Check</a> and
<a href="https://github.com/cemerick/double-check">DoubleCheck</a>. Because
Test.Check is an official Clojure library it is Clojure (JVM) only, so I
recommend DoubleCheck (maintained by Chas Emerick) which is capable of
cross compiling to Clojure and Clojurescript.</p>

<p>The only catch with DoubleCheck is that it&#8217;s not currently possible to
segregate tests via metadata for running in groups. But with the way we
will be running these tests that won&#8217;t be an issue.</p>

<h1>Setting up Leiningen</h1>

<p>First step, install <a href="http://leiningen.org/">Leiningen</a> and create a
project.clj wherever you Javascript code is. We&#8217;re going to use
<a href="https://github.com/emezeske/lein-cljsbuild">Cljsbuild</a> to compile our
testing code for execution. I in put my test code in test/cljs (because
I have clj and cljs based tests), and send the compiled output to
tmp/tracker-cljs.js. Note: this guide <em>only works for Clojurescript
0.0-2234</em>, I need to figure out why the latest build of Clojurescript
doesn&#8217;t work.</p>

<p>I highly recommend you send the output of the compilation process to
either a temporary or gitignored location. The output will be fairly
large, and it will bog down your repository with its size.</p>

<p>I don&#8217;t want to duplicate the Cljsbuild how-to, so if you don&#8217;t know how
to make it work, you should check their docs. Our project.clj is
reproduced at the bottom of this post if you have issues.</p>

<p>At this point, we can write the simplest test possible:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">tracker-cljs.simple-test</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.test.check</span> <span class="ss">:as</span> <span class="nv">core</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.test.check.generators</span> <span class="ss">:as</span> <span class="nv">gen</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.test.check.properties</span> <span class="ss">:as</span> <span class="nv">prop</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">cemerick.cljs.test</span> <span class="ss">:as</span> <span class="nv">t</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require-macros</span> <span class="p">[</span><span class="nv">clojure.test.check.clojure-test</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">defspec</span><span class="p">)]</span>
</span><span class='line'>                   <span class="p">[</span><span class="nv">clojure.test.check.properties</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">for-all</span><span class="p">)]</span>
</span><span class='line'>                   <span class="p">[</span><span class="nv">cemerick.cljs.test</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">is</span><span class="p">)]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defspec</span> <span class="nv">simple-test</span> <span class="mi">10</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">for-all</span> <span class="p">[</span><span class="nv">v</span> <span class="p">(</span><span class="nf">gen/such-that</span> <span class="nv">gen/not-empty</span> <span class="p">(</span><span class="nf">gen/vector</span> <span class="nv">gen/int</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">println </span><span class="nv">v</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">true</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h1>PhantomJS issues.</h1>

<p>In order to run the tests, you would typically have a :tests section in
:cljsbuild that looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="ss">:test-commands</span> <span class="p">{</span><span class="s">&quot;unit-tests&quot;</span> <span class="p">[</span><span class="s">&quot;phantomjs&quot;</span> <span class="ss">:runner</span>
</span><span class='line'>                                          <span class="s">&quot;compiled-application.js&quot;</span>
</span><span class='line'>                                          <span class="s">&quot;tmp/compiled-tests.js&quot;</span><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will load our JS into the app, along with the tests, and then run
them. But you might notice errors that look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">SECURITY_ERR</span><span class="err">:</span> <span class="nv">DOM</span> <span class="nv">Exception</span> <span class="mi">18</span><span class="err">:</span> <span class="nv">An</span> <span class="nv">attempt</span> <span class="nv">was</span> <span class="nv">made</span> <span class="nv">to</span> <span class="nv">break</span> <span class="nv">through</span> <span class="nv">the</span> <span class="nv">security</span> <span class="nv">policy</span> <span class="nv">of</span> <span class="nv">the</span> <span class="nv">user</span> <span class="nv">agent.</span>
</span></code></pre></td></tr></table></div></figure>


<p>That means that your app code is trying to access local storage, and
PhantomJS does not like it when you do that without loading a
webpage. The solution for this is to start a server so we have a page to
visit, and visit it via PhantomJS. So on Tracker we use the following
two bits of code.</p>

<p>generative_runner.js, to visit the actual page:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">//</span> <span class="nv">reusable</span> <span class="nv">PhantomJS</span> <span class="nv">script</span> <span class="nb">for </span><span class="nv">running</span> <span class="nv">clojurescript.test</span> <span class="nv">tests</span>
</span><span class='line'><span class="nv">//</span> <span class="nv">see</span> <span class="nv">http</span><span class="ss">://github.com/cemerick/clojurescript.test</span> <span class="nb">for </span><span class="nv">more</span> <span class="nv">info</span>
</span><span class='line'>
</span><span class='line'><span class="k">var </span><span class="nv">page</span> <span class="nb">= </span><span class="nv">require</span><span class="p">(</span><span class="ss">&#39;webpage</span><span class="o">&#39;</span><span class="p">)</span><span class="nv">.create</span><span class="p">()</span><span class="c1">;</span>
</span><span class='line'><span class="nv">page.onResourceError</span> <span class="nb">= </span><span class="nv">function</span><span class="p">(</span><span class="nf">resourceError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">page.reason</span> <span class="nb">= </span><span class="nv">resourceError.errorString</span><span class="c1">;</span>
</span><span class='line'>    <span class="nv">page.reason_url</span> <span class="nb">= </span><span class="nv">resourceError.url</span><span class="c1">;</span>
</span><span class='line'><span class="p">}</span><span class="c1">;</span>
</span><span class='line'><span class="k">var </span><span class="nv">fs</span> <span class="nb">= </span><span class="nv">require</span><span class="p">(</span><span class="ss">&#39;fs</span><span class="o">&#39;</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'><span class="k">var </span><span class="nv">sys</span> <span class="nb">= </span><span class="nv">require</span><span class="p">(</span><span class="ss">&#39;system</span><span class="o">&#39;</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'><span class="k">var </span><span class="nv">success</span><span class="c1">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">page.onConsoleMessage</span> <span class="nb">= </span><span class="nv">function</span> <span class="p">(</span><span class="nf">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var </span><span class="nv">line</span> <span class="nb">= </span><span class="nv">x.toString</span><span class="p">()</span><span class="c1">;</span>
</span><span class='line'>    <span class="k">if </span><span class="p">(</span><span class="nf">line</span> <span class="nv">!==</span> <span class="s">&quot;[NEWLINE]&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">sys.stdout.writeLine</span><span class="p">(</span><span class="nf">line.replace</span><span class="p">(</span><span class="nf">/</span><span class="sc">\[</span><span class="nv">NEWLINE</span><span class="sc">\]</span><span class="nv">/g</span>, <span class="s">&quot;\n&quot;</span><span class="p">))</span><span class="c1">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="c1">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">page.open</span><span class="p">(</span><span class="ss">&#39;http://localhost:4500</span><span class="o">&#39;</span>, <span class="nv">function</span><span class="p">(</span><span class="nf">status</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if </span><span class="p">(</span><span class="nf">status</span> <span class="nv">!==</span> <span class="s">&quot;success&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">console.log</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t load page&quot;</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'>        <span class="nv">phantom.exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nb">for </span><span class="p">(</span><span class="k">var </span><span class="nv">i</span> <span class="nb">= </span><span class="mi">1</span><span class="c1">; i &lt; sys.args.length; i++) {</span>
</span><span class='line'>        <span class="k">if </span><span class="p">(</span><span class="nf">fs.exists</span><span class="p">(</span><span class="nf">sys.args</span><span class="p">[</span><span class="nv">i</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if </span><span class="p">(</span><span class="nf">!page.injectJs</span><span class="p">(</span><span class="nf">sys.args</span><span class="p">[</span><span class="nv">i</span><span class="p">]))</span> <span class="nv">throw</span> <span class="k">new </span><span class="nv">Error</span><span class="p">(</span><span class="s">&quot;Failed to inject &quot;</span> <span class="nb">+ </span><span class="nv">sys.args</span><span class="p">[</span><span class="nv">i</span><span class="p">])</span><span class="c1">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="nv">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">page.evaluateJavaScript</span><span class="p">(</span><span class="s">&quot;(function () { &quot;</span> <span class="nb">+ </span><span class="nv">sys.args</span><span class="p">[</span><span class="nv">i</span><span class="p">]</span> <span class="nb">+ </span><span class="s">&quot;;&quot;</span> <span class="nb">+ </span><span class="s">&quot; })&quot;</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">page.evaluate</span><span class="p">(</span><span class="nf">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">cemerick.cljs.test.set_print_fn_BANG_</span><span class="p">(</span><span class="nf">function</span><span class="p">(</span><span class="nf">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">console.log</span><span class="p">(</span><span class="nf">x.replace</span><span class="p">(</span><span class="nf">/</span><span class="sc">\n</span><span class="nv">/g</span>, <span class="s">&quot;[NEWLINE]&quot;</span><span class="p">))</span><span class="c1">; // since console.log *itself* adds a newline</span>
</span><span class='line'>        <span class="p">})</span><span class="c1">;</span>
</span><span class='line'>    <span class="p">})</span><span class="c1">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">success</span> <span class="nb">= </span><span class="nv">page.evaluate</span><span class="p">(</span><span class="nf">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">var </span><span class="nv">results</span> <span class="nb">= </span><span class="nv">cemerick.cljs.test.run_all_tests</span><span class="p">()</span><span class="c1">;</span>
</span><span class='line'>        <span class="nv">console.log</span><span class="p">(</span><span class="nf">results</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'>        <span class="nv">return</span> <span class="nv">cemerick.cljs.test.successful_QMARK_</span><span class="p">(</span><span class="nf">results</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'>    <span class="p">})</span><span class="c1">;</span>
</span><span class='line'>    <span class="nv">phantom.exit</span><span class="p">(</span><span class="nf">success</span> <span class="nv">?</span> <span class="mi">0</span> <span class="err">:</span> <span class="mi">1</span><span class="p">)</span><span class="c1">;</span>
</span><span class='line'><span class="p">})</span><span class="c1">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And a rake task to stand up a server and run everything. If you don&#8217;t
use Rails for your Javascript code you might need to use different
commands to compile, but the intention remains. The WEBrick server
provides a blank page for us to visit and run our tests on, which
prevents PhantomJS from raising security errors.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">require</span> <span class="ss">&#39;fileutils</span><span class="o">&#39;</span>
</span><span class='line'><span class="nv">require</span> <span class="ss">&#39;webrick</span><span class="o">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">namespace </span><span class="ss">:test</span> <span class="nv">do</span>
</span><span class='line'>  <span class="nv">desc</span> <span class="s">&quot;Run ClojureScript generative tests&quot;</span>
</span><span class='line'>  <span class="nv">task</span> <span class="ss">:generative</span> <span class="nv">do</span>
</span><span class='line'>    <span class="nv">server</span> <span class="nb">= </span><span class="nv">WEBrick</span><span class="ss">::HTTPServer.new</span><span class="p">({</span><span class="ss">:Port</span> <span class="nv">=&gt;</span> <span class="mi">4500</span>, <span class="ss">:DocumentRoot</span> <span class="nv">=&gt;</span> <span class="s">&quot;.&quot;</span>, <span class="ss">:BindAddress</span> <span class="nv">=&gt;</span> <span class="s">&quot;0.0.0.0&quot;</span><span class="p">})</span>
</span><span class='line'>    <span class="nv">Thread.new</span> <span class="nv">do</span>
</span><span class='line'>      <span class="nv">server.start</span>
</span><span class='line'>    <span class="nv">end</span>
</span><span class='line'>    <span class="nv">exitCode</span> <span class="nb">= </span><span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">begin</span>
</span><span class='line'>      <span class="nv">Rake</span><span class="ss">::Task</span><span class="p">[</span><span class="ss">&#39;assets:clean</span><span class="o">&#39;</span><span class="p">]</span><span class="nv">.invoke</span>
</span><span class='line'>      <span class="nv">Rake</span><span class="ss">::Task</span><span class="p">[</span><span class="ss">&#39;assets:precompile</span><span class="o">&#39;</span><span class="p">]</span><span class="nv">.invoke</span>
</span><span class='line'>      <span class="nv">exitCode</span> <span class="nb">= </span><span class="nv">system</span> <span class="s">&quot;lein cljsbuild test&quot;</span>
</span><span class='line'>    <span class="nv">ensure</span>
</span><span class='line'>      <span class="nv">server.shutdown</span>
</span><span class='line'>    <span class="nv">end</span>
</span><span class='line'>    <span class="nv">exit</span> <span class="nv">exitCode</span>
</span><span class='line'>  <span class="nv">end</span>
</span><span class='line'><span class="nv">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To make all this work together, update project.clj to reference the
generative_runner.js file instead of :runner, and use <code>rake
test:generative</code> to kick off the run.</p>

<h1>Don&#8217;t Mangle Your Code</h1>

<p>If your application is anything like Tracker, you might use some Google
Closure dependencies without using the entire Closure compiler. And even
if you don&#8217;t need use Closure, you certainly have functions and classes
in the global namespace that you don&#8217;t want mangled.</p>

<p>To get around this, I recommend the following settings:</p>

<p>Add <code>:libs [ "compiled-application.js" ""]</code> to the cljsbuild section
in project.clj. This prevents DoubleCheck compiler errors due to
classpath issues, and it allows the Closure compiler to see everything
that your application provides. So if your tests and applications have
overlapping Closure dependencies you won&#8217;t get double provide errors.</p>

<p>Secondly I recommend that you only use the simple compilation mode. This
will prevent Closure from mangling global names, which will make
debugging easier and prevent your tests from being able to find the
production code. The space saving and code elimination that advanced
mode provides is more of a problem than a benefit for testing, so it&#8217;s
not worth fighting to get advanced to work.</p>

<p>You can fiddle with source maps if you wish, but I
haven&#8217;t had much luck or use for them; simple compiled Clojurescript is
easy to read, and most of the serious errors have come from the 43k
application javascript file, not the test file.</p>

<h1>Have Fun and Make More Tests</h1>

<p>Once you have that going, it should be possible to open up and create
increasingly complicated tests. As a teaser and a good example, the
following code caught a tricky JS ordering bug.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">tracker-cljs.panel-items-test</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.test.check</span> <span class="ss">:as</span> <span class="nv">core</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.test.check.generators</span> <span class="ss">:as</span> <span class="nv">gen</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.test.check.properties</span> <span class="ss">:as</span> <span class="nv">prop</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">cemerick.cljs.test</span> <span class="ss">:as</span> <span class="nv">t</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require-macros</span> <span class="p">[</span><span class="nv">clojure.test.check.clojure-test</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">defspec</span><span class="p">)]</span>
</span><span class='line'>                   <span class="p">[</span><span class="nv">clojure.test.check.properties</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">for-all</span><span class="p">)]</span>
</span><span class='line'>                   <span class="p">[</span><span class="nv">cemerick.cljs.test</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">is</span><span class="p">)]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">ids</span> <span class="p">[</span><span class="nv">items</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">seq? </span><span class="nv">items</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">item</span><span class="p">]</span> <span class="p">(</span><span class="nf">.get</span> <span class="nv">item</span> <span class="ss">:id</span><span class="p">))</span>
</span><span class='line'>         <span class="nv">items</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">item</span><span class="p">]</span> <span class="p">(</span><span class="nf">.get</span> <span class="nv">item</span> <span class="ss">:id</span><span class="p">))</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">.-models</span> <span class="nv">items</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">create-models</span> <span class="p">[</span><span class="nv">ids</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">x</span><span class="p">]</span> <span class="p">(</span><span class="nf">Backbone.Model.</span> <span class="p">(</span><span class="nf">js-obj</span> <span class="ss">:id</span> <span class="nv">x</span><span class="p">)))</span>
</span><span class='line'>       <span class="nv">ids</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defspec</span> <span class="nv">sort-check</span> <span class="mi">100</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">for-all</span> <span class="p">[</span><span class="nv">v</span> <span class="p">(</span><span class="nf">gen/such-that</span> <span class="nv">gen/not-empty</span> <span class="p">(</span><span class="nf">gen/vector</span> <span class="nv">gen/int</span><span class="p">))]</span>
</span><span class='line'>           <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">models</span> <span class="p">(</span><span class="nf">create-models</span> <span class="nv">v</span><span class="p">)</span>
</span><span class='line'>                 <span class="nv">sorted</span> <span class="p">(</span><span class="nb">sort </span><span class="nv">v</span><span class="p">)</span>
</span><span class='line'>                 <span class="nv">subject</span> <span class="p">(</span><span class="nf">tracker.PanelItems.</span><span class="p">)]</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">.reset</span> <span class="nv">subject</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">array</span> <span class="nv">models</span><span class="p">))</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">.refresh</span> <span class="nv">subject</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">array</span> <span class="p">(</span><span class="nb">sort-by </span><span class="o">#</span><span class="p">(</span><span class="nf">.get</span> <span class="nv">%</span> <span class="ss">:id</span><span class="p">)</span> <span class="nv">models</span><span class="p">)))</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nb">= </span><span class="nv">sorted</span>
</span><span class='line'>                    <span class="p">(</span><span class="nf">ids</span> <span class="nv">subject</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the following is our project.clj, with unnecessary details elided
for readability.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">generative-testing</span> <span class="s">&quot;0.0.1-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-cljsbuild</span> <span class="s">&quot;1.0.3&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">com.cemerick/clojurescript.test</span> <span class="s">&quot;0.2.2&quot;</span><span class="p">]]</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojurescript</span> <span class="s">&quot;0.0-2234&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">com.cemerick/clojurescript.test</span> <span class="s">&quot;0.3.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">com.cemerick/double-check</span> <span class="s">&quot;0.5.8-SNAPSHOT&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]]</span>
</span><span class='line'>  <span class="ss">:cljsbuild</span> <span class="p">{</span><span class="ss">:builds</span> <span class="p">[{</span><span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;test/cljs&quot;</span><span class="p">]</span>
</span><span class='line'>                        <span class="ss">:compiler</span> <span class="p">{</span><span class="ss">:output-to</span> <span class="s">&quot;tmp/tracker-cljs.js&quot;</span>
</span><span class='line'>                                   <span class="ss">:libs</span> <span class="p">[</span> <span class="s">&quot;public/web/assets/application.js&quot;</span> <span class="s">&quot;&quot;</span><span class="p">]</span>
</span><span class='line'>                                   <span class="ss">:optimizations</span> <span class="ss">:simple</span>
</span><span class='line'>                                   <span class="ss">:pretty-print</span> <span class="nv">true</span><span class="p">}}]</span>
</span><span class='line'>              <span class="ss">:test-commands</span> <span class="p">{</span><span class="s">&quot;unit-tests&quot;</span> <span class="p">[</span><span class="s">&quot;phantomjs&quot;</span> <span class="s">&quot;lib/generative_runner.js&quot;</span>
</span><span class='line'>                                            <span class="s">&quot;public/next/assets/next/next.js&quot;</span>
</span><span class='line'>                                            <span class="s">&quot;tmp/tracker-cljs.js&quot;</span><span class="p">]}})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also, the following function is helpful for converting from Cljs data
structures to pure Javascript ones. It causes some compiler warnings,
but they appear to be harmless.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">clj-&gt;js</span>
</span><span class='line'>  <span class="s">&quot;Recursively transforms ClojureScript maps into Javascript objects,</span>
</span><span class='line'><span class="s">   other ClojureScript colls into JavaScript arrays, and ClojureScript</span>
</span><span class='line'><span class="s">   keywords into JavaScript strings.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">x</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">cond</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">string? </span><span class="nv">x</span><span class="p">)</span> <span class="nv">x</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">keyword? </span><span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">name </span><span class="nv">x</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">map? </span><span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">js-obj</span> <span class="p">(</span><span class="nf">flatten</span> <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nb">key </span><span class="nv">val</span><span class="p">]]</span> <span class="p">[(</span><span class="nf">clj-&gt;js</span> <span class="nv">key</span><span class="p">)</span> <span class="p">(</span><span class="nf">clj-&gt;js</span> <span class="nv">val</span><span class="p">)])</span> <span class="nv">x</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">coll?</span> <span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">array</span> <span class="p">(</span><span class="nb">map </span><span class="nv">clj-&gt;js</span> <span class="nv">x</span><span class="p">))</span>
</span><span class='line'>    <span class="ss">:else</span> <span class="nv">x</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Good luck, and don&#8217;t hesitate to reach out to me on Twitter if you have
any questions!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (Ashton Kemerling)" rel="author">Ashton Kemerling</a></span></span>

      








  


<time datetime="2014-09-25T08:41:00-07:00" pubdate data-updated="true">Sep 25<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/programming/'>programming</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.ashtonkemerling.com/blog/2014/09/25/integrating-test-dot-check-and-javascript/" data-via="ashtonkemerling" data-counturl="http://www.ashtonkemerling.com/blog/2014/09/25/integrating-test-dot-check-and-javascript/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/06/19/unusual-productivity-hacks/" title="Previous Post: Unusual Productivity Hacks">&laquo; Unusual Productivity Hacks</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/06/11/my-increasing-frustration-with-clojure/" title="next Post: My Increasing Frustration With Clojure">My Increasing Frustration With Clojure &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Ashton Kemerling -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ashtonkemerling';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.ashtonkemerling.com/blog/2014/09/25/integrating-test-dot-check-and-javascript/';
        var disqus_url = 'http://www.ashtonkemerling.com/blog/2014/09/25/integrating-test-dot-check-and-javascript/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
