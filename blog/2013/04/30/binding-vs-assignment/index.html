
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Binding vs. Assignment  - Ashton Kemerling</title>
  <meta name="author" content="Ashton Kemerling">

  
  <meta name="description" content="A coworker of mine was recently running into problems with the following snippet of Python code, and turned to another functionally oriented &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://AshtonKem.github.io/blog/2013/04/30/binding-vs-assignment">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Ashton Kemerling" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32325955-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <h1>Ashton Kemerling</h1>
  
    <h2><a href="/">AK</a></h2>
  
</hgroup>

</header>
  <nav role="navigation">
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-me">About Me</a></li>
  <li><a href="/consulting">Consulting</a></li>
  <li><a href="/resume">Resume</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Binding vs. Assignment</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-30T07:23:00-07:00" pubdate data-updated="true">Apr 30<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>A coworker of mine was recently running into problems with the following snippet of Python code, and turned to another functionally oriented developer and myself for help.</p>

<figure class='code'><figcaption><span>Odd Functions</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">funs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;a&quot;</span> <span class="s">&quot;b&quot;</span><span class="p">]:</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">internal_function</span><span class="p">():</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">i</span>
</span><span class='line'>    <span class="n">funs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">internal_function</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">funs</span><span class="p">[</span><span class="mi">0</span><span class="p">]()</span>
</span><span class='line'><span class="k">print</span> <span class="n">funs</span><span class="p">[</span><span class="mi">1</span><span class="p">]()</span>
</span></code></pre></td></tr></table></div></figure>


<p>At first glance, one would expect this to print &#8220;a&#8221; then &#8220;b&#8221;. But much to my surprise (and my coworkers frustration), it was returning &#8220;b&#8221; both times.</p>

<p>My first instinct was that Python was closing properly, but was messing up the namespacing. So I asked him to use lambdas instead, creating this:</p>

<figure class='code'><figcaption><span>Lambdas</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">funs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">]:</span>
</span><span class='line'>    <span class="n">funs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="n">i</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">funs</span><span class="p">[</span><span class="mi">0</span><span class="p">]()</span>
</span><span class='line'><span class="k">print</span> <span class="n">funs</span><span class="p">[</span><span class="mi">1</span><span class="p">]()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Same result! So by this point we know that its not namespacing that is causing the problems, as you can&#8217;t accidentally assign two lambdas the same name. So I began to suspect that the use of &#8220;i&#8221; was the issue. Perhaps we&#8217;re closing around i, which is a mutable variable, and Python can&#8217;t anticipate that we want a copy instead of the actual reference. Since i is mutable, both closures are having what i means changed from underneath them after closure creation time. (Coincidentally, Python 2.7.3 keeps i around even after the loop is completed, which I think is odd).</p>

<p>So the solution here would be to use a temporary variable. Any variable first created inside a loop should theoretically only have a lifespan of one iteration through the loop. So let&#8217;s try the following:</p>

<figure class='code'><figcaption><span>Temporary Variables</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">funs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">]:</span>
</span><span class='line'>    <span class="n">temp</span> <span class="o">=</span> <span class="n">i</span>
</span><span class='line'>    <span class="n">funs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="n">temp</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">funs</span><span class="p">[</span><span class="mi">0</span><span class="p">]()</span>
</span><span class='line'><span class="k">print</span> <span class="n">funs</span><span class="p">[</span><span class="mi">1</span><span class="p">]()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Same result, again! So clearly python is mishandling variables by a large amount. So what&#8217;s going on here? My fellow functional coworker was finally able to explain: the real problem here is that Python conflates binding and assignment. Binding is used to create a new variable <em>within the current context</em>, while assignment can only change the value of a given variable within the narrowest bound scope.</p>

<p>Why is this an issue? Well, Python uses the same symbol &#8220;=&#8221;, to specify binding and assignment, while most other languages use two syntactic rules. For example Go apparently uses &#8220;:=&#8221; to bind, and &#8220;=&#8221; to assign. Java uses type declarations to denote bindings, and Clojure/Haskell more or less only have bindings underneath. Unfortunately there&#8217;s an upper limit to how intelligent an imperative compiler can get, especially in interpreted languages where the compiler must be fairly quick. So Python doesn&#8217;t do the leg work to realize that temp is only used inside the loop, and binds it only once <em>outside the loop</em>. The side effect of this is that anyone who closes over any local variable inside the loop will be surprised when it is mutated by further iterations, and said variables will be left laying around <strong>after the loop is done</strong>.</p>

<p>So how do we get out of this? One obvious option is to pick a language that understands the difference. Short of that, use a separate function to force Python&#8217;s hand.</p>

<figure class='code'><figcaption><span>Ugly Fix</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">create_lambda</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">x</span>
</span><span class='line'>
</span><span class='line'><span class="n">funs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">]:</span>
</span><span class='line'>    <span class="n">funs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">create_lambda</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">funs</span><span class="p">[</span><span class="mi">0</span><span class="p">]()</span>
</span><span class='line'><span class="n">funs</span><span class="p">[</span><span class="mi">1</span><span class="p">]()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which unfortunately is pretty ugly. Other languages will get you out of this bind though. Clojure has no concept of assigning variables, only binding. So the only way to create mutable state in Clojure is through successive binds, or via the special Software Transactional Memory functions, which are specially designed for concurrency.</p>

<figure class='code'><figcaption><span>Nice and Clean</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">funs</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">for </span><span class="p">[</span><span class="nv">i</span> <span class="p">[</span><span class="s">&quot;a&quot;</span> <span class="s">&quot;b&quot;</span><span class="p">]]</span>
</span><span class='line'>         <span class="p">(</span><span class="k">fn </span><span class="p">[]</span>
</span><span class='line'>             <span class="nv">i</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">println </span><span class="p">((</span><span class="nb">first </span><span class="nv">funs</span><span class="p">)))</span>
</span><span class='line'><span class="p">(</span><span class="nb">println </span><span class="p">((</span><span class="nb">second </span><span class="nv">funs</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And according to my Go enthused coworker, this also works:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="nx">i</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="p">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">tmp</span> <span class="o">:=</span> <span class="nx">i</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">funs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="kd">func</span> <span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">tmp</span>
</span><span class='line'>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">funs</span><span class="p">[</span><span class="mi">0</span><span class="p">]())</span>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">funs</span><span class="p">[</span><span class="mi">1</span><span class="p">]())</span>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">funs</span><span class="p">[</span><span class="mi">2</span><span class="p">]())</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are currently working on a Python project, or are a Python enthusiast, the only hope is to be careful, and hope that Python 3&#8217;s compiler might be more intelligent.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (Ashton Kemerling)" rel="author">Ashton Kemerling</a></span></span>

      








  


<time datetime="2013-04-30T07:23:00-07:00" pubdate data-updated="true">Apr 30<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/programming/'>programming</a>, <a class='category' href='/blog/categories/python/'>python</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://AshtonKem.github.io/blog/2013/04/30/binding-vs-assignment/" data-via="ashtonkemerling" data-counturl="http://AshtonKem.github.io/blog/2013/04/30/binding-vs-assignment/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/04/23/size-matters/" title="Previous Post: Size Matters">&laquo; Size Matters</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/04/30/a-new-addiction/" title="next Post: A New Addiction">A New Addiction &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Ashton Kemerling -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ashtonkemerling';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://AshtonKem.github.io/blog/2013/04/30/binding-vs-assignment/';
        var disqus_url = 'http://AshtonKem.github.io/blog/2013/04/30/binding-vs-assignment/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
